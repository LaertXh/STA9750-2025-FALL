<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Laert Xhumari">
<meta name="dcterms.date" content="2025-12-16">

<title>Traffic Volume Impact on NYC Residents – STA 9750 Submission Material</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-dec27a635df3619fee3abd01ce5a42f4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">STA 9750 Submission Material</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./mp01.html"> 
<span class="menu-text">MP01</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./mp02.html"> 
<span class="menu-text">MP02</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./mp04.html"> 
<span class="menu-text">MP04</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./individual_report.html" aria-current="page"> 
<span class="menu-text">Individual Report</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Traffic Volume Impact on NYC Residents</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Laert Xhumari </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 16, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p><img src="images/final_intro.webp" class="img-fluid"></p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Lets take a closer look into how traffic impacts the daily lives of NYC residents. In order to accomplish this, we will use the dataset from the “311 Service Requests”, which holds complaints that the residents of New York make every day. We will look into specific issues regarding traffic. This means that we will also need traffic data. For this other dataset we will use the “Automated Traffic Volume Counts”, both datasets come from NYC Open Data.</p>
<p>The specific question I will tackle is the following. What statistically significant street-level spatial hot-spots and hour/day temporal hotspots exist for traffic related complaints?</p>
<p>When it comes to the street level insights, we will uncover some of the busiest intersections that exists in NYC, as well as taking a look at the map with all of the relevant complaints mapped out. As for the time hotspots, we will examine how relevant complaints to traffic shift throughout the day and compare the data with that of the traffic volume.</p>
</section>
<section id="data-preparation-cleaning" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation-cleaning">Data Preparation &amp; Cleaning</h2>
<div class="cell">
<details class="code-fold">
<summary>CODE: Dependencies</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>CODE: Helper function for formatted output</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>format_numbers_kable <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">decimals =</span> <span class="dv">2</span>, <span class="at">format =</span> <span class="st">"simple"</span>, <span class="at">exclude =</span> <span class="cn">NULL</span>) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  df_fmt <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format numeric columns except excluded ones</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">where</span>(is.numeric) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">all_of</span>(exclude),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> <span class="fu">number</span>(.x,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">big.mark =</span> <span class="st">","</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">accuracy =</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span>decimals))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert all columns to character for consistent printing</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), as.character)) <span class="sc">|&gt;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean header names</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename_with</span>(<span class="sc">~</span> .x <span class="sc">|&gt;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">str_replace_all</span>(<span class="st">"_"</span>, <span class="st">" "</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">str_to_title</span>()</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(df_fmt, <span class="at">format =</span> format)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>CODE: 311 Dataset</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>base_url  <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/erm2-nwe9.csv"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>batch_dir <span class="ot">&lt;-</span> <span class="st">"data/311_batch"</span>          <span class="co"># folder for per-batch files</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>batch_pattern <span class="ot">&lt;-</span> <span class="st">"^nyc_311_2024_batch_(</span><span class="sc">\\</span><span class="st">d+)</span><span class="sc">\\</span><span class="st">.csv$"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"unique_key"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"created_date"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"agency"</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"complaint_type"</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"descriptor"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"location_type"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"incident_zip"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"incident_address"</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"street_name"</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cross_street_1"</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cross_street_2"</span>,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"intersection_street_1"</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"intersection_street_2"</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"address_type"</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"city"</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"landmark"</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"borough"</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"x_coordinate_state_plane"</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"y_coordinate_state_plane"</span>,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"latitude"</span>,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"longitude"</span>,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"location"</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>where_2024 <span class="ot">&lt;-</span> <span class="st">"created_date between '2024-01-01T00:00:00' and '2024-12-31T23:59:59'"</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Force consistent column types (all character to avoid bind_rows issues)</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>col_spec <span class="ot">&lt;-</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="fu">col_character</span>())</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper: figure out where to resume (batch index + offset)</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>get_resume_state <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(batch_dir)) {</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(batch_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">next_batch_id =</span> <span class="dv">1</span>L, <span class="at">offset =</span> <span class="dv">0</span>L))</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  existing_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(batch_dir, <span class="at">pattern =</span> batch_pattern, <span class="at">full.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(existing_files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">next_batch_id =</span> <span class="dv">1</span>L, <span class="at">offset =</span> <span class="dv">0</span>L))</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract batch numbers from filenames</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>  batch_nums <span class="ot">&lt;-</span> <span class="fu">str_match</span>(existing_files, batch_pattern)[, <span class="dv">2</span>]</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>  batch_nums <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(batch_nums[<span class="sc">!</span><span class="fu">is.na</span>(batch_nums)])</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>  max_batch <span class="ot">&lt;-</span> <span class="fu">max</span>(batch_nums)</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each batch uses limit = batch_size and no overlap,</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># so starting offset for the *next* batch is:</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  offset <span class="ot">&lt;-</span> (max_batch) <span class="sc">*</span> batch_size</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">next_batch_id =</span> max_batch <span class="sc">+</span> <span class="dv">1</span>L, <span class="at">offset =</span> offset)</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Download in batches with httr2, writing each batch to disk</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>download_311_2024_batches <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>  resume <span class="ot">&lt;-</span> <span class="fu">get_resume_state</span>()</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>  batch_id <span class="ot">&lt;-</span> resume<span class="sc">$</span>next_batch_id</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>  offset   <span class="ot">&lt;-</span> resume<span class="sc">$</span>offset</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Starting (or resuming) at batch %d, offset %d"</span>, batch_id, offset))</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>  <span class="cf">repeat</span> {</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Requesting batch %d (offset = %d)..."</span>, batch_id, offset))</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    req <span class="ot">&lt;-</span> <span class="fu">request</span>(base_url) <span class="sc">|&gt;</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_url_query</span>(</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$select"</span> <span class="ot">=</span> <span class="fu">paste</span>(cols, <span class="at">collapse =</span> <span class="st">","</span>),</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$where"</span>  <span class="ot">=</span> where_2024,</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$limit"</span>  <span class="ot">=</span> batch_size,</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$offset"</span> <span class="ot">=</span> offset</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> req <span class="sc">|&gt;</span> <span class="fu">req_perform</span>()</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    raw_csv <span class="ot">&lt;-</span> resp <span class="sc">|&gt;</span> <span class="fu">resp_body_raw</span>()</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    chunk   <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(raw_csv, <span class="at">col_types =</span> col_spec, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(chunk) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"No more rows returned; finished downloading."</span>)</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write this batch immediately to disk</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    out_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(batch_dir, <span class="fu">sprintf</span>(<span class="st">"nyc_311_2024_batch_%04d.csv"</span>, batch_id))</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(chunk, out_path)</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"  Retrieved %d rows and wrote '%s'."</span>, <span class="fu">nrow</span>(chunk), out_path))</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(chunk) <span class="sc">&lt;</span> batch_size) {</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Last (partial) batch received; stopping."</span>)</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>    offset   <span class="ot">&lt;-</span> offset <span class="sc">+</span> batch_size</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>    batch_id <span class="ot">&lt;-</span> batch_id <span class="sc">+</span> <span class="dv">1</span>L</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="fl">0.25</span>)  <span class="co"># be polite to the API</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a><span class="co"># write and read final file </span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>final_file <span class="ot">&lt;-</span> <span class="st">"data/nyc_311_2024_full.csv"</span> </span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>load_all_311_2024_batches <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">write_final =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(batch_dir)) {</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Batch directory does not exist: "</span>, batch_dir)</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>  files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(batch_dir, <span class="at">pattern =</span> batch_pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No batch files found in: "</span>, batch_dir)</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Loading %d batch files..."</span>, <span class="fu">length</span>(files)))</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>  dfs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(files, <span class="cf">function</span>(f) {</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_csv</span>(f, <span class="at">col_types =</span> col_spec, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dfs)</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (write_final) {</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="fu">dirname</span>(final_file), <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(df, final_file)</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Wrote combined data to '%s'."</span>, final_file))</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a><span class="co"># use final combined file if present; otherwise build it</span></span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(final_file)) {</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Final file '%s' exists. Loading for analysis..."</span>, final_file))</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>  data_311_2024 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(final_file, <span class="at">col_types =</span> col_spec, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Final file '%s' not found. Ensuring batches are downloaded..."</span>, final_file))</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This will resume from whatever batches we have</span></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download_311_2024_batches</span>()</span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load all batches, write final file, and return combined df</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>  data_311_2024 <span class="ot">&lt;-</span> <span class="fu">load_all_311_2024_batches</span>(<span class="at">write_final =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a><span class="co"># ready for analysis</span></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a><span class="co"># str(data_311_2024)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>CODE: Traffic Dataset</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Config for Automated Traffic Volume Counts</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>base_url_traffic   <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/7ym2-wayt.csv"</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>batch_dir_traffic  <span class="ot">&lt;-</span> <span class="st">"data/traffic_batch"</span>   <span class="co"># folder for per-batch files</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>batch_pattern_traffic <span class="ot">&lt;-</span> <span class="st">"^nyc_traffic_counts_batch_(</span><span class="sc">\\</span><span class="st">d+)</span><span class="sc">\\</span><span class="st">.csv$"</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>final_file_traffic <span class="ot">&lt;-</span> <span class="st">"data/nyc_traffic_automated_counts_full.csv"</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>batch_size_traffic <span class="ot">&lt;-</span> <span class="dv">50000</span> </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Force consistent column types to avoid bind_rows() issues across batches</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>col_spec_traffic <span class="ot">&lt;-</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="fu">col_character</span>())</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper: figure out where to resume (batch index + offset)</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>get_resume_state_traffic <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(batch_dir_traffic)) {</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(batch_dir_traffic, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">next_batch_id =</span> <span class="dv">1</span>L, <span class="at">offset =</span> <span class="dv">0</span>L))</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  existing_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    batch_dir_traffic,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">pattern =</span> batch_pattern_traffic,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">full.names =</span> <span class="cn">FALSE</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(existing_files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">next_batch_id =</span> <span class="dv">1</span>L, <span class="at">offset =</span> <span class="dv">0</span>L))</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract batch numbers from filenames</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  batch_nums <span class="ot">&lt;-</span> <span class="fu">str_match</span>(existing_files, batch_pattern_traffic)[, <span class="dv">2</span>]</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  batch_nums <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(batch_nums[<span class="sc">!</span><span class="fu">is.na</span>(batch_nums)])</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  max_batch <span class="ot">&lt;-</span> <span class="fu">max</span>(batch_nums)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each batch uses limit = batch_size_traffic and no overlap,</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># so starting offset for the *next* batch is:</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  offset <span class="ot">&lt;-</span> (max_batch) <span class="sc">*</span> batch_size_traffic</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">next_batch_id =</span> max_batch <span class="sc">+</span> <span class="dv">1</span>L, <span class="at">offset =</span> offset)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Download in batches with httr2, writing each batch to disk</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>download_traffic_batches <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>  resume  <span class="ot">&lt;-</span> <span class="fu">get_resume_state_traffic</span>()</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  batch_id <span class="ot">&lt;-</span> resume<span class="sc">$</span>next_batch_id</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  offset   <span class="ot">&lt;-</span> resume<span class="sc">$</span>offset</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Starting (or resuming) traffic download at batch %d, offset %d"</span>,</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    batch_id, offset</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  <span class="cf">repeat</span> {</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Traffic: requesting batch %d (offset = %d)..."</span>, batch_id, offset))</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get data</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    req <span class="ot">&lt;-</span> <span class="fu">request</span>(base_url_traffic) <span class="sc">|&gt;</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_url_query</span>(</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$limit"</span>  <span class="ot">=</span> batch_size_traffic,</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$offset"</span> <span class="ot">=</span> offset</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> req <span class="sc">|&gt;</span> <span class="fu">req_perform</span>()</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    raw_csv <span class="ot">&lt;-</span> resp <span class="sc">|&gt;</span> <span class="fu">resp_body_raw</span>()</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    chunk   <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(raw_csv, <span class="at">col_types =</span> col_spec_traffic, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(chunk) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"No more rows returned; finished traffic download."</span>)</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write this batch immediately to disk</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    out_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>      batch_dir_traffic,</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">"nyc_traffic_counts_batch_%04d.csv"</span>, batch_id)</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(chunk, out_path)</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"  Traffic: retrieved %d rows and wrote '%s'."</span>, <span class="fu">nrow</span>(chunk), out_path))</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(chunk) <span class="sc">&lt;</span> batch_size_traffic) {</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Traffic: last (partial) batch received; stopping."</span>)</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    offset   <span class="ot">&lt;-</span> offset <span class="sc">+</span> batch_size_traffic</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    batch_id <span class="ot">&lt;-</span> batch_id <span class="sc">+</span> <span class="dv">1</span>L</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="fl">0.25</span>)  <span class="co"># be polite to the API</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper: load and combine all traffic batches; optionally write final file</span></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>load_all_traffic_batches <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">write_final =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(batch_dir_traffic)) {</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Traffic batch directory does not exist: "</span>, batch_dir_traffic)</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>  files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>    batch_dir_traffic,</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">pattern   =</span> batch_pattern_traffic,</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">full.names =</span> <span class="cn">TRUE</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No traffic batch files found in: "</span>, batch_dir_traffic)</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Loading %d traffic batch files..."</span>, <span class="fu">length</span>(files)))</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>  dfs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(files, <span class="cf">function</span>(f) {</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_csv</span>(f, <span class="at">col_types =</span> col_spec_traffic, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dfs)</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (write_final) {</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="fu">dirname</span>(final_file_traffic), <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(df, final_file_traffic)</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Wrote combined traffic data to '%s'."</span>, final_file_traffic))</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Main: use final traffic file if present; otherwise build it</span></span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(final_file_traffic)) {</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Final traffic file '%s' exists. Loading for analysis..."</span>,</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>    final_file_traffic</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>  traffic_counts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>    final_file_traffic,</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_types =</span> col_spec_traffic,</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_col_types =</span> <span class="cn">FALSE</span></span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Final traffic file '%s' not found. Ensuring batches are downloaded..."</span>,</span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>    final_file_traffic</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This will resume from whatever batches you already have</span></span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download_traffic_batches</span>()</span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load all batches, write final file, and return combined df</span></span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>  traffic_counts <span class="ot">&lt;-</span> <span class="fu">load_all_traffic_batches</span>(<span class="at">write_final =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a><span class="co"># ready for analysis</span></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a><span class="co"># str(traffic_counts)</span></span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>traffic_counts_2024 <span class="ot">&lt;-</span> traffic_counts <span class="sc">%&gt;%</span></span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(yr <span class="sc">==</span> <span class="st">"2024"</span>)</span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>traffic_monthly <span class="ot">&lt;-</span> traffic_counts <span class="sc">%&gt;%</span></span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">yr =</span> <span class="fu">as.integer</span>(yr),</span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">m  =</span> <span class="fu">as.integer</span>(m),</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">vol =</span> <span class="fu">as.numeric</span>(vol)</span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(yr <span class="sc">==</span> <span class="dv">2025</span>) <span class="sc">%&gt;%</span>          <span class="co"># only 2024 if desired</span></span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(boro, m) <span class="sc">%&gt;%</span>           <span class="co"># group by borough + month</span></span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_volume =</span> <span class="fu">sum</span>(vol, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_records =</span> <span class="fu">n</span>()</span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(boro, m)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The 311 dataset is incredibly large. This was one of the biggest reason why we decided to focus on the 2024 year only, as downloading just this year took about 15 minutes. The strategy when downloading the data is to do it once and never again. This means that when we download the data we save it in folder called data so next time we can just read locally. We do not just write the final file, we write each batch, just in case the download interrupts, we can continue where we left off. This is not as necessary for comfort when it comes to the traffic dataset, however the same strategy is applied there, because being kind to th api is important.</p>
</section>
<section id="street-level-analysis" class="level2">
<h2 class="anchored" data-anchor-id="street-level-analysis">Street Level Analysis</h2>
<div class="cell">
<details class="code-fold">
<summary>CODE: Mapping NYC 311 Complaints</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Normalize 311 column names</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>df311 <span class="ot">&lt;-</span> data_311_2024</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>df311 <span class="ot">&lt;-</span> df311 <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitude =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(longitude)),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">latitude  =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(latitude))</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># keep only plausible NYC coords </span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>df311 <span class="ot">&lt;-</span> df311 <span class="sc">|&gt;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(longitude) <span class="sc">|</span> (longitude <span class="sc">&gt;=</span> <span class="sc">-</span><span class="fl">74.3</span> <span class="sc">&amp;</span> longitude <span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">73.6</span>),</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(latitude)  <span class="sc">|</span> (latitude  <span class="sc">&gt;=</span>  <span class="fl">40.45</span> <span class="sc">&amp;</span> latitude  <span class="sc">&lt;=</span> <span class="fl">40.95</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Load NYC boundaries</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>relevant_complaints <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Noise - Vehicle"</span>, <span class="st">"Illegal Parking"</span>, <span class="st">"Blocked Driveway"</span>, <span class="st">"Traffic Signal Condition"</span>, <span class="st">"Street Condition"</span>, <span class="st">"Street Light Condition"</span>, <span class="st">"Street Sign - Damaged"</span>, <span class="st">"Street Sign - Dangling"</span>, <span class="st">"Street Sign - Missing"</span>, <span class="st">"Noise - Street/Sidewalk"</span>, <span class="st">"Highway Sign - Missing"</span>, <span class="st">"Bridge Condition"</span>, <span class="st">"Abandoned Vehicle"</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>boroughs_url <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/gthc-hcne.geojson"</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>modzcta_url  <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/pri4-ifjk.geojson"</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>nyc_boroughs <span class="ot">&lt;-</span> <span class="fu">st_read</span>(boroughs_url, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">st_make_valid</span>()</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>nyc_outline  <span class="ot">&lt;-</span> <span class="fu">st_union</span>(nyc_boroughs)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>nyc_modzcta  <span class="ot">&lt;-</span> <span class="fu">st_read</span>(modzcta_url, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">st_make_valid</span>()</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) All Noise - Vehicle complaints (points)</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>noise_vehicle_all <span class="ot">&lt;-</span> df311 <span class="sc">|&gt;</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(complaint_type <span class="sc">%in%</span> relevant_complaints ) <span class="sc">|&gt;</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude), <span class="sc">!</span><span class="fu">is.na</span>(latitude)) <span class="sc">|&gt;</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(borough), borough <span class="sc">!=</span> <span class="st">"Unspecified"</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>noise_vehicle_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  noise_vehicle_all,</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>),</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="dv">4326</span>,</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Top intersection per borough (INTERSECTION only)</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>top_intersections <span class="ot">&lt;-</span> df311 <span class="sc">|&gt;</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(complaint_type <span class="sc">==</span> <span class="st">"Noise - Vehicle"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(borough), borough <span class="sc">!=</span> <span class="st">"Unspecified"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_to_upper</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(address_type))) <span class="sc">==</span> <span class="st">"INTERSECTION"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">s1 =</span> <span class="fu">na_if</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(intersection_street_1)), <span class="st">""</span>),</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">s2 =</span> <span class="fu">na_if</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(intersection_street_2)), <span class="st">""</span>)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(s1), <span class="sc">!</span><span class="fu">is.na</span>(s2)) <span class="sc">|&gt;</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">a =</span> <span class="fu">pmin</span>(s1, s2),</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">b =</span> <span class="fu">pmax</span>(s1, s2),</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">intersection =</span> <span class="fu">paste</span>(a, b, <span class="at">sep =</span> <span class="st">" &amp; "</span>)</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(borough, intersection, <span class="at">name =</span> <span class="st">"total_complaints"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(borough) <span class="sc">|&gt;</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(total_complaints, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Attach coordinates for those top intersections</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a><span class="co">#    (mean lat/lon of matching complaints, now numeric)</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>top_intersections_geo <span class="ot">&lt;-</span> df311 <span class="sc">|&gt;</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(complaint_type <span class="sc">==</span> <span class="st">"Noise - Vehicle"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(borough), borough <span class="sc">!=</span> <span class="st">"Unspecified"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_to_upper</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(address_type))) <span class="sc">==</span> <span class="st">"INTERSECTION"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude), <span class="sc">!</span><span class="fu">is.na</span>(latitude)) <span class="sc">|&gt;</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">s1 =</span> <span class="fu">na_if</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(intersection_street_1)), <span class="st">""</span>),</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">s2 =</span> <span class="fu">na_if</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(intersection_street_2)), <span class="st">""</span>),</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">a  =</span> <span class="fu">pmin</span>(s1, s2),</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">b  =</span> <span class="fu">pmax</span>(s1, s2),</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">intersection =</span> <span class="fu">paste</span>(a, b, <span class="at">sep =</span> <span class="st">" &amp; "</span>)</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(top_intersections, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"borough"</span>, <span class="st">"intersection"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(borough, intersection, total_complaints) <span class="sc">|&gt;</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitude =</span> <span class="fu">mean</span>(longitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">latitude  =</span> <span class="fu">mean</span>(latitude,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude), <span class="sc">!</span><span class="fu">is.na</span>(latitude))   <span class="co"># ensure valid coords</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>top_intersections_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>  top_intersections_geo,</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>),</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="dv">4326</span>,</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) CRS alignment</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>target_crs <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(nyc_outline)</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>nyc_outline_aligned  <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(nyc_outline, target_crs)</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>nyc_modzcta_aligned  <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(nyc_modzcta, target_crs)</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>noise_points_aligned <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(noise_vehicle_sf, target_crs)</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>top_points_aligned   <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(top_intersections_sf, target_crs)</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Labels</span></span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>top_points_aligned <span class="ot">&lt;-</span> top_points_aligned <span class="sc">|&gt;</span></span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">paste0</span>(intersection, <span class="st">" ("</span>, total_complaints, <span class="st">")"</span>))</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a><span class="co"># 7) Final map</span></span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> nyc_outline_aligned,</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">"grey90"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.35</span>) <span class="sc">+</span></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> nyc_modzcta_aligned,</span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"grey60"</span>, <span class="at">linewidth =</span> <span class="fl">0.20</span>) <span class="sc">+</span></span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> noise_points_aligned,</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> top_points_aligned,</span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">color =</span> borough),</span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Dark2"</span>) <span class="sc">+</span></span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"NYC 311 Noise – Vehicle Complaints (2024)"</span>,</span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Highlighted dots show the most-reported INTERSECTION per borough"</span>,</span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Borough"</span>,</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span></span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="individual_report_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Number of Complaints by Borough</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>vehicle_related_issues_by_borough <span class="ot">&lt;-</span> df311 <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(complaint_type <span class="sc">%in%</span> relevant_complaints) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(borough), borough <span class="sc">!=</span> <span class="st">"Unspecified"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(borough, <span class="at">name =</span> <span class="st">"total_complaints"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_complaints))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">format_numbers_kable</span>(vehicle_related_issues_by_borough, <span class="at">decimals =</span> <span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Borough</th>
<th style="text-align: left;">Total Complaints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">BROOKLYN</td>
<td style="text-align: left;">381,142</td>
</tr>
<tr class="even">
<td style="text-align: left;">QUEENS</td>
<td style="text-align: left;">337,762</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BRONX</td>
<td style="text-align: left;">185,457</td>
</tr>
<tr class="even">
<td style="text-align: left;">MANHATTAN</td>
<td style="text-align: left;">171,893</td>
</tr>
<tr class="odd">
<td style="text-align: left;">STATEN ISLAND</td>
<td style="text-align: left;">39,728</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>First I want to explain the purpose of the chart, it’s meant to give a better representation of what the numbers mean. Its hard to look at just some number and really understand the scale and severity of these issues. If you were to just look at the number, you may think that this is not a huge problem in Manhattan, after all its the 4th spot on the list. Yet after looking at the map, it looks like someone painted manhattan with a brush.</p>
<p>I want to point out that I am not using all of the complaints here. I am selecting only relevant complaints, for a complete list, look into the “relevant_complaints” variable from the code block under “CODE: Mapping NYC 311 Complaints”.</p>
<div class="cell">
<details class="code-fold">
<summary>Top Intersections</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>top_sorted <span class="ot">&lt;-</span> top_intersections <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">as.numeric</span>(total_complaints)))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">format_numbers_kable</span>(top_sorted, <span class="at">decimals =</span> <span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Borough</th>
<th style="text-align: left;">Intersection</th>
<th style="text-align: left;">Total Complaints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">MANHATTAN</td>
<td style="text-align: left;">7 AVENUE &amp; WEST 53 STREET</td>
<td style="text-align: left;">173</td>
</tr>
<tr class="even">
<td style="text-align: left;">BROOKLYN</td>
<td style="text-align: left;">CHURCH AVENUE &amp; EAST 3 STREET</td>
<td style="text-align: left;">121</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BRONX</td>
<td style="text-align: left;">BROOK AVENUE &amp; EAST 171 STREET</td>
<td style="text-align: left;">52</td>
</tr>
<tr class="even">
<td style="text-align: left;">QUEENS</td>
<td style="text-align: left;">MEADOW DRIVE &amp; MEADOW LAKE ROAD WEST</td>
<td style="text-align: left;">48</td>
</tr>
<tr class="odd">
<td style="text-align: left;">STATEN ISLAND</td>
<td style="text-align: left;">ELTINGVILLE BOULEVARD &amp; GURLEY AVENUE</td>
<td style="text-align: left;">10</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following are the busiest intersection in each borough. These data points can also be seen on the map, they are the big dots placed. What I find most interesting is <strong>7 AVENUE &amp; WEST 53 STREET</strong>, given that it’s dead center. While Manhattan receives one of the smallest number of total relevant complaints, it’s impacted by it more due to how congested it is. Given this, we can predict that traffic flow and complaints will flow more fluently together then in other boroughs. Lets test this hypothesis.</p>
</section>
<section id="hour-hotspots-of-traffic-and-complaints" class="level2">
<h2 class="anchored" data-anchor-id="hour-hotspots-of-traffic-and-complaints">Hour Hotspots of Traffic and Complaints</h2>
<p>For this section we will look into borough level, hourly hotspots throughout the 2024 year. The traffic dataset does not have every month for each borough, but the hourly data is very reliable. We will plot these data points to see how the boroughs and different type of complaints may relate to traffic.</p>
<div class="cell">
<details class="code-fold">
<summary>Compute Hourly Data</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>complaints_hourly <span class="ot">&lt;-</span> data_311_2024 <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(created_date, complaint_type, borough) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure created_date is parsed correctly</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">created_date =</span> <span class="fu">ymd_hms</span>(created_date, <span class="at">tz =</span> <span class="st">"UTC"</span>),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">exact_hour   =</span> <span class="fu">as.integer</span>(<span class="fu">hour</span>(created_date)),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">borough =</span> <span class="fu">str_to_title</span>(<span class="fu">str_trim</span>(borough))</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    exact_hour,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    borough,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    complaint_type</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">complaint_count =</span> <span class="fu">n</span>(),</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>traffic_hourly <span class="ot">&lt;-</span> traffic_counts <span class="sc">%&gt;%</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">exact_hour =</span> <span class="fu">as.integer</span>(hh),</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">borough =</span> <span class="fu">str_to_title</span>(<span class="fu">str_trim</span>(boro)),</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">vol        =</span> <span class="fu">as.numeric</span>(vol)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    exact_hour,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    borough</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_traffic_volume =</span> <span class="fu">mean</span>(vol, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>complaints_traffic_joined <span class="ot">&lt;-</span> complaints_hourly <span class="sc">%&gt;%</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    traffic_hourly,</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"exact_hour"</span>, <span class="st">"borough"</span>)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The traffic dataset already has a hourly column but for the 311 dataset we must extract the hour. After the extraction is completed, we group by borough and hour, then we can join the two dataset with those fields respectively.</p>
<p>I have decided to keep complaints as a count (total), while the traffic is average. The reasoning is due to some complaint types being very low in volume, and a count is a better representation.</p>
<div class="cell">
<details class="code-fold">
<summary>Function to Plot Any Given Borough</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>plot_complaints_vs_traffic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, complaint_types, borough_name) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  boro <span class="ot">&lt;-</span> <span class="fu">str_to_title</span>(<span class="fu">str_trim</span>(borough_name))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  complaint_types <span class="ot">&lt;-</span> <span class="fu">as.character</span>(complaint_types)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">borough =</span> <span class="fu">str_to_title</span>(<span class="fu">str_trim</span>(borough)),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">exact_hour =</span> <span class="fu">as.integer</span>(exact_hour)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>      borough <span class="sc">==</span> boro,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>      complaint_type <span class="sc">%in%</span> complaint_types</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(exact_hour, borough) <span class="sc">%&gt;%</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">complaint_count =</span> <span class="fu">sum</span>(complaint_count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">avg_traffic_volume =</span> <span class="fu">mean</span>(avg_traffic_volume, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(exact_hour)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(df) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No rows after filtering. Check borough name and complaint types."</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scale factor for dual axis</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  max_c <span class="ot">&lt;-</span> <span class="fu">max</span>(df<span class="sc">$</span>complaint_count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  max_v <span class="ot">&lt;-</span> <span class="fu">max</span>(df<span class="sc">$</span>avg_traffic_volume, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.finite</span>(max_v) <span class="sc">||</span> max_v <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"avg_traffic_volume is all NA/0 after filtering; cannot scale secondary axis."</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>  scale_factor <span class="ot">&lt;-</span> max_c <span class="sc">/</span> max_v</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Long format just for plotting clarity</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  plot_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">%&gt;%</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">transmute</span>(</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        exact_hour,</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">value =</span> complaint_count,</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">series =</span> <span class="st">"Complaint count"</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">%&gt;%</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">transmute</span>(</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>        exact_hour,</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">value =</span> avg_traffic_volume <span class="sc">*</span> scale_factor,</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">series =</span> <span class="st">"Average traffic volume"</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x =</span> exact_hour, <span class="at">y =</span> value, <span class="at">color =</span> series, <span class="at">linetype =</span> series)) <span class="sc">+</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">23</span>) <span class="sc">+</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Complaint count (sum across selected types)"</span>,</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> . <span class="sc">/</span> scale_factor,</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">"Average traffic volume"</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Complaint count"</span> <span class="ot">=</span> <span class="st">"#1f77b4"</span>,</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Average traffic volume"</span> <span class="ot">=</span> <span class="st">"#d62728"</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Complaint count"</span> <span class="ot">=</span> <span class="st">"solid"</span>,</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Average traffic volume"</span> <span class="ot">=</span> <span class="st">"dashed"</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Complaints vs Traffic Volume —"</span>, boro),</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Complaint types:"</span>, <span class="fu">paste</span>(complaint_types, <span class="at">collapse =</span> <span class="st">", "</span>)),</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Hour of day (0–23)"</span>,</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="cn">NULL</span>,</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">linetype =</span> <span class="cn">NULL</span></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>) <span class="sc">+</span></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">aspect.ratio =</span> <span class="fl">0.45</span>   </span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="vehicle---noise" class="level4">
<h4 class="anchored" data-anchor-id="vehicle---noise">Vehicle - Noise</h4>
<div class="cell">
<details class="code-fold">
<summary>Queens Vehicle - Noise</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> <span class="fu">c</span>(<span class="st">"Noise - Vehicle"</span>),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Queens"</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="individual_report_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Manhattan Vehicle - Noise</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> <span class="fu">c</span>(<span class="st">"Noise - Vehicle"</span>),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Manhattan"</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="individual_report_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is a representation of how “Noise - Vehicle” complaints relate against the traffic volume for Queens and Manhattan respectively. These charts are double sided, which means that the Y-axis holds both, traffic volume metrics and the complaint counts without losing out on scale. The boroughs need to be plotted separately, if we do not, then we will lose out on proper scale as well as it looks very messy.</p>
<p>The representation of vehicle noise complaints is a great reality check. While it’s easy to assume that they would be tightly correlated, they are not. This is due to people not being bothered by vehicle noise early morning but find it very bothersome towards the night when they want to sleep.</p>
<p>The rest of the boroughs display similar patterns.</p>
</section>
<section id="illegal---parking" class="level4">
<h4 class="anchored" data-anchor-id="illegal---parking">Illegal - Parking</h4>
<div class="cell">
<details class="code-fold">
<summary>Queens Illegal Parking</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> <span class="fu">c</span>(<span class="st">"Illegal Parking"</span>),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Queens"</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="individual_report_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Manhattan Illegal Parking</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> <span class="fu">c</span>(<span class="st">"Illegal Parking"</span>),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Manhattan"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="individual_report_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we start to see some real change. Illegal parking is a huge issue in Manhattan. I worked at Lexington Avenue for a many years. This avenue has a total of five lanes, yet people illegal parked constantly, reducing the lanes available all the way down to one. Two of the side lanes would be blocked by legal parking, the other lane far right was for busses only and one lane was often blocked by people illegally double parking. As we see by the chart, the people of New York will report these issues frequently and they tend to be very time accurate, as reporting illegal parking right away is crucial, not when the person has left.</p>
<p>In Queens, the reports do not follow as closely to the traffic volume, mostly after 12 PM. This may be due to Queens being much bigger then Manhattan and may not get impacted by traffic as much, given that there are much more open spaces, highways and boulevards. After 12pm, queens tends to be a little less active then Manhattan anyway, as most people are in the city working. This would track given the massive rise in complaints towards the night, since a lot of people would be coming back home.</p>
<div class="cell">
<details class="code-fold">
<summary>Manhattan Relevant Complaints</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> relevant_complaints,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Manhattan"</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="individual_report_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally we want to look into relevant complaints being analyzed at a hourly level. These are the exact list of complaints shown in the previous section, the map. This data will overwhelm any outliers such as the “Noise -Vehicle” complaints, since everything is being included here. We can see for the map of Manhattan there eis incredibly close correlation between the traffic volume and the relevant complaints. The one big difference is towards the end, after 7 PM, we notice a spike on the number of complaints while traffic volume keeps declining.</p>
<p>Keep in mind this is any relevant complaints here, so think even broken street signs or bad road conditions. I believe that this is the reason why this spike happens in Manhattan, as people will not report most things on the spot. Rather when their day is done, they may recall a pothole or something else that the city is just refusing to handle over time, and decide to send that complaint out when they finally get a minute to do so. I know I have done this for Queens Boulevard, which is riddled with some of the worst potholes I have ever experience while driving in New York.</p>
<div class="cell">
<details class="code-fold">
<summary>Queens Relevant Complaints</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> relevant_complaints,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Queens"</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="individual_report_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Queens has a bit less correlation then Manhattan. Just as we noticed with the illegal parking, on the afternoon the complaints seem to deviate from the direction of the traffic volume. This may be linked to what was pointed before, that Queens gets a bit more inactive on the afternoon.</p>
<p>When I am comparing correlation, I deem Manhattan to be better correlated, because the movement of the complaints volume throughout the day match that of the traffic volume. Queens has the two lines flow closer together but the movement flow does not match as well.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>When it comes to analytics, I strongly recommend to not rely on just the numbers. It’s very difficult to get a good sense of the impact the data has unless you plot it into a map (if they are coordinates). It helps to see the impact that the data has, because we may just compare and think that it’s not as impactful. When it comes to mapping out the data here we got a clear picture on how many 311 complaints get sent out, and these are only the relevant complaints to traffic.</p>
<p>Based on what the hourly analytics resulted, I can confidently say that as traffic volume goes up, related traffic 311 complaints also go up. However we need to be realistic on how people send out complaints. For time sensitive events, such as illegal parking, the data tends to be very reliable with traffic flow. For other events such as car noises, people do not really care to complain until they want to sleep. Also I strongly believe that the major rise in complaints later on the night has to do with people finally having a moment to send it out, as well as wanting some piece and quiet.</p>
<p>My teammates were able to uncover other correlations, such as air pollution complaints being linked to heavy traffic volume. With these findings, NYC can use the 311 complaints to figure out which areas may need more resources. Knowing which intersections receive the most complaints and at what time the traffic is at it’s peek, can help the city to send officers so traffic is safer and better organized.</p>
<section id="overcoming-challenges" class="level4">
<h4 class="anchored" data-anchor-id="overcoming-challenges">Overcoming Challenges</h4>
<p>We had a bit of an issue with the traffic volume dataset. Some months were missing, so boroughs did not have consistent data. I tried my best to find other datasets, some were locked behind paywalls while promising excellent results (so they say at least). Late into the project I was able to put together some yellow taxicab data, for the trips they make throughout New York. This dataset was not used due to time constraints, as it would require a whole rewriting of our topic at such a late date.</p>
<p>However we made due with what we were able to put together after the 2nd milestone presentation that we made for the project. Thank you!</p>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/laertxh\.github\.io\/STA9750-2025-FALL\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Traffic Volume Impact on NYC Residents"</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Laert Xhumari"</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 12/16/2025</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false    # hide warnings globally</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false    # hide package messages globally </span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="an">knitr:</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">  opts_chunk:</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">    results: "hold" # hold output until end of chunk </span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/final_intro.webp)</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>Lets take a closer look into how traffic impacts the daily lives of NYC residents. In order to accomplish this, we will use the dataset from the "311 Service Requests", which holds complaints that the residents of New York make every day. We will look into specific issues regarding traffic. This means that we will also need traffic data. For this other dataset we will use the "Automated Traffic Volume Counts", both datasets come from NYC Open Data.</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>The specific question I will tackle is the following. What statistically significant street-level spatial hot-spots and hour/day temporal hotspots exist for traffic related complaints? </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>When it comes to the street level insights, we will uncover some of the busiest intersections that exists in NYC, as well as taking a look at the map with all of the relevant complaints mapped out. As for the time hotspots, we will examine how relevant complaints to traffic shift throughout the day and compare the data with that of the traffic volume.</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Preparation &amp; Cleaning</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "CODE: Dependencies"</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr) </span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "CODE: Helper function for formatted output"</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>format_numbers_kable <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">decimals =</span> <span class="dv">2</span>, <span class="at">format =</span> <span class="st">"simple"</span>, <span class="at">exclude =</span> <span class="cn">NULL</span>) {</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>  df_fmt <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format numeric columns except excluded ones</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>        <span class="fu">where</span>(is.numeric) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">all_of</span>(exclude),</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> <span class="fu">number</span>(.x,</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>                 <span class="at">big.mark =</span> <span class="st">","</span>,</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>                 <span class="at">accuracy =</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span>decimals))</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert all columns to character for consistent printing</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), as.character)) <span class="sc">|&gt;</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean header names</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename_with</span>(<span class="sc">~</span> .x <span class="sc">|&gt;</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">str_replace_all</span>(<span class="st">"_"</span>, <span class="st">" "</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">str_to_title</span>()</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(df_fmt, <span class="at">format =</span> format)</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "CODE: 311 Dataset"</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>base_url  <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/erm2-nwe9.csv"</span></span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>batch_dir <span class="ot">&lt;-</span> <span class="st">"data/311_batch"</span>          <span class="co"># folder for per-batch files</span></span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>batch_pattern <span class="ot">&lt;-</span> <span class="st">"^nyc_311_2024_batch_(</span><span class="sc">\\</span><span class="st">d+)</span><span class="sc">\\</span><span class="st">.csv$"</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>  <span class="st">"unique_key"</span>,</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>  <span class="st">"created_date"</span>,</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>  <span class="st">"agency"</span>,</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>  <span class="st">"complaint_type"</span>,</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>  <span class="st">"descriptor"</span>,</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>  <span class="st">"location_type"</span>,</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>  <span class="st">"incident_zip"</span>,</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>  <span class="st">"incident_address"</span>,</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>  <span class="st">"street_name"</span>,</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cross_street_1"</span>,</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cross_street_2"</span>,</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>  <span class="st">"intersection_street_1"</span>,</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>  <span class="st">"intersection_street_2"</span>,</span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>  <span class="st">"address_type"</span>,</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>  <span class="st">"city"</span>,</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>  <span class="st">"landmark"</span>,</span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>  <span class="st">"borough"</span>,</span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>  <span class="st">"x_coordinate_state_plane"</span>,</span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>  <span class="st">"y_coordinate_state_plane"</span>,</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>  <span class="st">"latitude"</span>,</span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>  <span class="st">"longitude"</span>,</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>  <span class="st">"location"</span></span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>where_2024 <span class="ot">&lt;-</span> <span class="st">"created_date between '2024-01-01T00:00:00' and '2024-12-31T23:59:59'"</span></span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Force consistent column types (all character to avoid bind_rows issues)</span></span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a>col_spec <span class="ot">&lt;-</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="fu">col_character</span>())</span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper: figure out where to resume (batch index + offset)</span></span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a>get_resume_state <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(batch_dir)) {</span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(batch_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">next_batch_id =</span> <span class="dv">1</span>L, <span class="at">offset =</span> <span class="dv">0</span>L))</span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a>  existing_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(batch_dir, <span class="at">pattern =</span> batch_pattern, <span class="at">full.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(existing_files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">next_batch_id =</span> <span class="dv">1</span>L, <span class="at">offset =</span> <span class="dv">0</span>L))</span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract batch numbers from filenames</span></span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a>  batch_nums <span class="ot">&lt;-</span> <span class="fu">str_match</span>(existing_files, batch_pattern)[, <span class="dv">2</span>]</span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a>  batch_nums <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(batch_nums[<span class="sc">!</span><span class="fu">is.na</span>(batch_nums)])</span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a>  max_batch <span class="ot">&lt;-</span> <span class="fu">max</span>(batch_nums)</span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each batch uses limit = batch_size and no overlap,</span></span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># so starting offset for the *next* batch is:</span></span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>  offset <span class="ot">&lt;-</span> (max_batch) <span class="sc">*</span> batch_size</span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">next_batch_id =</span> max_batch <span class="sc">+</span> <span class="dv">1</span>L, <span class="at">offset =</span> offset)</span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-146"><a href="#cb16-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Download in batches with httr2, writing each batch to disk</span></span>
<span id="cb16-147"><a href="#cb16-147" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-148"><a href="#cb16-148" aria-hidden="true" tabindex="-1"></a>download_311_2024_batches <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-149"><a href="#cb16-149" aria-hidden="true" tabindex="-1"></a>  resume <span class="ot">&lt;-</span> <span class="fu">get_resume_state</span>()</span>
<span id="cb16-150"><a href="#cb16-150" aria-hidden="true" tabindex="-1"></a>  batch_id <span class="ot">&lt;-</span> resume<span class="sc">$</span>next_batch_id</span>
<span id="cb16-151"><a href="#cb16-151" aria-hidden="true" tabindex="-1"></a>  offset   <span class="ot">&lt;-</span> resume<span class="sc">$</span>offset</span>
<span id="cb16-152"><a href="#cb16-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-153"><a href="#cb16-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Starting (or resuming) at batch %d, offset %d"</span>, batch_id, offset))</span>
<span id="cb16-154"><a href="#cb16-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-155"><a href="#cb16-155" aria-hidden="true" tabindex="-1"></a>  <span class="cf">repeat</span> {</span>
<span id="cb16-156"><a href="#cb16-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Requesting batch %d (offset = %d)..."</span>, batch_id, offset))</span>
<span id="cb16-157"><a href="#cb16-157" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-158"><a href="#cb16-158" aria-hidden="true" tabindex="-1"></a>    req <span class="ot">&lt;-</span> <span class="fu">request</span>(base_url) <span class="sc">|&gt;</span></span>
<span id="cb16-159"><a href="#cb16-159" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_url_query</span>(</span>
<span id="cb16-160"><a href="#cb16-160" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$select"</span> <span class="ot">=</span> <span class="fu">paste</span>(cols, <span class="at">collapse =</span> <span class="st">","</span>),</span>
<span id="cb16-161"><a href="#cb16-161" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$where"</span>  <span class="ot">=</span> where_2024,</span>
<span id="cb16-162"><a href="#cb16-162" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$limit"</span>  <span class="ot">=</span> batch_size,</span>
<span id="cb16-163"><a href="#cb16-163" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$offset"</span> <span class="ot">=</span> offset</span>
<span id="cb16-164"><a href="#cb16-164" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-165"><a href="#cb16-165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-166"><a href="#cb16-166" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> req <span class="sc">|&gt;</span> <span class="fu">req_perform</span>()</span>
<span id="cb16-167"><a href="#cb16-167" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-168"><a href="#cb16-168" aria-hidden="true" tabindex="-1"></a>    raw_csv <span class="ot">&lt;-</span> resp <span class="sc">|&gt;</span> <span class="fu">resp_body_raw</span>()</span>
<span id="cb16-169"><a href="#cb16-169" aria-hidden="true" tabindex="-1"></a>    chunk   <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(raw_csv, <span class="at">col_types =</span> col_spec, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-170"><a href="#cb16-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-171"><a href="#cb16-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(chunk) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb16-172"><a href="#cb16-172" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"No more rows returned; finished downloading."</span>)</span>
<span id="cb16-173"><a href="#cb16-173" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb16-174"><a href="#cb16-174" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-175"><a href="#cb16-175" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-176"><a href="#cb16-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write this batch immediately to disk</span></span>
<span id="cb16-177"><a href="#cb16-177" aria-hidden="true" tabindex="-1"></a>    out_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(batch_dir, <span class="fu">sprintf</span>(<span class="st">"nyc_311_2024_batch_%04d.csv"</span>, batch_id))</span>
<span id="cb16-178"><a href="#cb16-178" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(chunk, out_path)</span>
<span id="cb16-179"><a href="#cb16-179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"  Retrieved %d rows and wrote '%s'."</span>, <span class="fu">nrow</span>(chunk), out_path))</span>
<span id="cb16-180"><a href="#cb16-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-181"><a href="#cb16-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(chunk) <span class="sc">&lt;</span> batch_size) {</span>
<span id="cb16-182"><a href="#cb16-182" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Last (partial) batch received; stopping."</span>)</span>
<span id="cb16-183"><a href="#cb16-183" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb16-184"><a href="#cb16-184" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-185"><a href="#cb16-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-186"><a href="#cb16-186" aria-hidden="true" tabindex="-1"></a>    offset   <span class="ot">&lt;-</span> offset <span class="sc">+</span> batch_size</span>
<span id="cb16-187"><a href="#cb16-187" aria-hidden="true" tabindex="-1"></a>    batch_id <span class="ot">&lt;-</span> batch_id <span class="sc">+</span> <span class="dv">1</span>L</span>
<span id="cb16-188"><a href="#cb16-188" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-189"><a href="#cb16-189" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="fl">0.25</span>)  <span class="co"># be polite to the API</span></span>
<span id="cb16-190"><a href="#cb16-190" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-191"><a href="#cb16-191" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-192"><a href="#cb16-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-193"><a href="#cb16-193" aria-hidden="true" tabindex="-1"></a><span class="co"># write and read final file </span></span>
<span id="cb16-194"><a href="#cb16-194" aria-hidden="true" tabindex="-1"></a>final_file <span class="ot">&lt;-</span> <span class="st">"data/nyc_311_2024_full.csv"</span> </span>
<span id="cb16-195"><a href="#cb16-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-196"><a href="#cb16-196" aria-hidden="true" tabindex="-1"></a>load_all_311_2024_batches <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">write_final =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb16-197"><a href="#cb16-197" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(batch_dir)) {</span>
<span id="cb16-198"><a href="#cb16-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Batch directory does not exist: "</span>, batch_dir)</span>
<span id="cb16-199"><a href="#cb16-199" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-200"><a href="#cb16-200" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-201"><a href="#cb16-201" aria-hidden="true" tabindex="-1"></a>  files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(batch_dir, <span class="at">pattern =</span> batch_pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-202"><a href="#cb16-202" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-203"><a href="#cb16-203" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb16-204"><a href="#cb16-204" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No batch files found in: "</span>, batch_dir)</span>
<span id="cb16-205"><a href="#cb16-205" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-206"><a href="#cb16-206" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-207"><a href="#cb16-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Loading %d batch files..."</span>, <span class="fu">length</span>(files)))</span>
<span id="cb16-208"><a href="#cb16-208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-209"><a href="#cb16-209" aria-hidden="true" tabindex="-1"></a>  dfs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(files, <span class="cf">function</span>(f) {</span>
<span id="cb16-210"><a href="#cb16-210" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_csv</span>(f, <span class="at">col_types =</span> col_spec, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-211"><a href="#cb16-211" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb16-212"><a href="#cb16-212" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-213"><a href="#cb16-213" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dfs)</span>
<span id="cb16-214"><a href="#cb16-214" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-215"><a href="#cb16-215" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (write_final) {</span>
<span id="cb16-216"><a href="#cb16-216" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="fu">dirname</span>(final_file), <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-217"><a href="#cb16-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(df, final_file)</span>
<span id="cb16-218"><a href="#cb16-218" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Wrote combined data to '%s'."</span>, final_file))</span>
<span id="cb16-219"><a href="#cb16-219" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-220"><a href="#cb16-220" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-221"><a href="#cb16-221" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb16-222"><a href="#cb16-222" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-223"><a href="#cb16-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-224"><a href="#cb16-224" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-225"><a href="#cb16-225" aria-hidden="true" tabindex="-1"></a><span class="co"># use final combined file if present; otherwise build it</span></span>
<span id="cb16-226"><a href="#cb16-226" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-227"><a href="#cb16-227" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(final_file)) {</span>
<span id="cb16-228"><a href="#cb16-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Final file '%s' exists. Loading for analysis..."</span>, final_file))</span>
<span id="cb16-229"><a href="#cb16-229" aria-hidden="true" tabindex="-1"></a>  data_311_2024 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(final_file, <span class="at">col_types =</span> col_spec, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-230"><a href="#cb16-230" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb16-231"><a href="#cb16-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Final file '%s' not found. Ensuring batches are downloaded..."</span>, final_file))</span>
<span id="cb16-232"><a href="#cb16-232" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-233"><a href="#cb16-233" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This will resume from whatever batches we have</span></span>
<span id="cb16-234"><a href="#cb16-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download_311_2024_batches</span>()</span>
<span id="cb16-235"><a href="#cb16-235" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-236"><a href="#cb16-236" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load all batches, write final file, and return combined df</span></span>
<span id="cb16-237"><a href="#cb16-237" aria-hidden="true" tabindex="-1"></a>  data_311_2024 <span class="ot">&lt;-</span> <span class="fu">load_all_311_2024_batches</span>(<span class="at">write_final =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-238"><a href="#cb16-238" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-239"><a href="#cb16-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-240"><a href="#cb16-240" aria-hidden="true" tabindex="-1"></a><span class="co"># ready for analysis</span></span>
<span id="cb16-241"><a href="#cb16-241" aria-hidden="true" tabindex="-1"></a><span class="co"># str(data_311_2024)</span></span>
<span id="cb16-242"><a href="#cb16-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-243"><a href="#cb16-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-244"><a href="#cb16-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-247"><a href="#cb16-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-248"><a href="#cb16-248" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "CODE: Traffic Dataset"</span></span>
<span id="cb16-249"><a href="#cb16-249" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-250"><a href="#cb16-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-251"><a href="#cb16-251" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-252"><a href="#cb16-252" aria-hidden="true" tabindex="-1"></a><span class="co"># Config for Automated Traffic Volume Counts</span></span>
<span id="cb16-253"><a href="#cb16-253" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-254"><a href="#cb16-254" aria-hidden="true" tabindex="-1"></a>base_url_traffic   <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/7ym2-wayt.csv"</span></span>
<span id="cb16-255"><a href="#cb16-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-256"><a href="#cb16-256" aria-hidden="true" tabindex="-1"></a>batch_dir_traffic  <span class="ot">&lt;-</span> <span class="st">"data/traffic_batch"</span>   <span class="co"># folder for per-batch files</span></span>
<span id="cb16-257"><a href="#cb16-257" aria-hidden="true" tabindex="-1"></a>batch_pattern_traffic <span class="ot">&lt;-</span> <span class="st">"^nyc_traffic_counts_batch_(</span><span class="sc">\\</span><span class="st">d+)</span><span class="sc">\\</span><span class="st">.csv$"</span></span>
<span id="cb16-258"><a href="#cb16-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-259"><a href="#cb16-259" aria-hidden="true" tabindex="-1"></a>final_file_traffic <span class="ot">&lt;-</span> <span class="st">"data/nyc_traffic_automated_counts_full.csv"</span></span>
<span id="cb16-260"><a href="#cb16-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-261"><a href="#cb16-261" aria-hidden="true" tabindex="-1"></a>batch_size_traffic <span class="ot">&lt;-</span> <span class="dv">50000</span> </span>
<span id="cb16-262"><a href="#cb16-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-263"><a href="#cb16-263" aria-hidden="true" tabindex="-1"></a><span class="co"># Force consistent column types to avoid bind_rows() issues across batches</span></span>
<span id="cb16-264"><a href="#cb16-264" aria-hidden="true" tabindex="-1"></a>col_spec_traffic <span class="ot">&lt;-</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="fu">col_character</span>())</span>
<span id="cb16-265"><a href="#cb16-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-266"><a href="#cb16-266" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-267"><a href="#cb16-267" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper: figure out where to resume (batch index + offset)</span></span>
<span id="cb16-268"><a href="#cb16-268" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-269"><a href="#cb16-269" aria-hidden="true" tabindex="-1"></a>get_resume_state_traffic <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-270"><a href="#cb16-270" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(batch_dir_traffic)) {</span>
<span id="cb16-271"><a href="#cb16-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(batch_dir_traffic, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-272"><a href="#cb16-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">next_batch_id =</span> <span class="dv">1</span>L, <span class="at">offset =</span> <span class="dv">0</span>L))</span>
<span id="cb16-273"><a href="#cb16-273" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-274"><a href="#cb16-274" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-275"><a href="#cb16-275" aria-hidden="true" tabindex="-1"></a>  existing_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb16-276"><a href="#cb16-276" aria-hidden="true" tabindex="-1"></a>    batch_dir_traffic,</span>
<span id="cb16-277"><a href="#cb16-277" aria-hidden="true" tabindex="-1"></a>    <span class="at">pattern =</span> batch_pattern_traffic,</span>
<span id="cb16-278"><a href="#cb16-278" aria-hidden="true" tabindex="-1"></a>    <span class="at">full.names =</span> <span class="cn">FALSE</span></span>
<span id="cb16-279"><a href="#cb16-279" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-280"><a href="#cb16-280" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-281"><a href="#cb16-281" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(existing_files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb16-282"><a href="#cb16-282" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">next_batch_id =</span> <span class="dv">1</span>L, <span class="at">offset =</span> <span class="dv">0</span>L))</span>
<span id="cb16-283"><a href="#cb16-283" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-284"><a href="#cb16-284" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-285"><a href="#cb16-285" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract batch numbers from filenames</span></span>
<span id="cb16-286"><a href="#cb16-286" aria-hidden="true" tabindex="-1"></a>  batch_nums <span class="ot">&lt;-</span> <span class="fu">str_match</span>(existing_files, batch_pattern_traffic)[, <span class="dv">2</span>]</span>
<span id="cb16-287"><a href="#cb16-287" aria-hidden="true" tabindex="-1"></a>  batch_nums <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(batch_nums[<span class="sc">!</span><span class="fu">is.na</span>(batch_nums)])</span>
<span id="cb16-288"><a href="#cb16-288" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-289"><a href="#cb16-289" aria-hidden="true" tabindex="-1"></a>  max_batch <span class="ot">&lt;-</span> <span class="fu">max</span>(batch_nums)</span>
<span id="cb16-290"><a href="#cb16-290" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-291"><a href="#cb16-291" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each batch uses limit = batch_size_traffic and no overlap,</span></span>
<span id="cb16-292"><a href="#cb16-292" aria-hidden="true" tabindex="-1"></a>  <span class="co"># so starting offset for the *next* batch is:</span></span>
<span id="cb16-293"><a href="#cb16-293" aria-hidden="true" tabindex="-1"></a>  offset <span class="ot">&lt;-</span> (max_batch) <span class="sc">*</span> batch_size_traffic</span>
<span id="cb16-294"><a href="#cb16-294" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-295"><a href="#cb16-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">next_batch_id =</span> max_batch <span class="sc">+</span> <span class="dv">1</span>L, <span class="at">offset =</span> offset)</span>
<span id="cb16-296"><a href="#cb16-296" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-297"><a href="#cb16-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-298"><a href="#cb16-298" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-299"><a href="#cb16-299" aria-hidden="true" tabindex="-1"></a><span class="co"># Download in batches with httr2, writing each batch to disk</span></span>
<span id="cb16-300"><a href="#cb16-300" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-301"><a href="#cb16-301" aria-hidden="true" tabindex="-1"></a>download_traffic_batches <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-302"><a href="#cb16-302" aria-hidden="true" tabindex="-1"></a>  resume  <span class="ot">&lt;-</span> <span class="fu">get_resume_state_traffic</span>()</span>
<span id="cb16-303"><a href="#cb16-303" aria-hidden="true" tabindex="-1"></a>  batch_id <span class="ot">&lt;-</span> resume<span class="sc">$</span>next_batch_id</span>
<span id="cb16-304"><a href="#cb16-304" aria-hidden="true" tabindex="-1"></a>  offset   <span class="ot">&lt;-</span> resume<span class="sc">$</span>offset</span>
<span id="cb16-305"><a href="#cb16-305" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-306"><a href="#cb16-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(</span>
<span id="cb16-307"><a href="#cb16-307" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Starting (or resuming) traffic download at batch %d, offset %d"</span>,</span>
<span id="cb16-308"><a href="#cb16-308" aria-hidden="true" tabindex="-1"></a>    batch_id, offset</span>
<span id="cb16-309"><a href="#cb16-309" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb16-310"><a href="#cb16-310" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-311"><a href="#cb16-311" aria-hidden="true" tabindex="-1"></a>  <span class="cf">repeat</span> {</span>
<span id="cb16-312"><a href="#cb16-312" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Traffic: requesting batch %d (offset = %d)..."</span>, batch_id, offset))</span>
<span id="cb16-313"><a href="#cb16-313" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-314"><a href="#cb16-314" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get data</span></span>
<span id="cb16-315"><a href="#cb16-315" aria-hidden="true" tabindex="-1"></a>    req <span class="ot">&lt;-</span> <span class="fu">request</span>(base_url_traffic) <span class="sc">|&gt;</span></span>
<span id="cb16-316"><a href="#cb16-316" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_url_query</span>(</span>
<span id="cb16-317"><a href="#cb16-317" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$limit"</span>  <span class="ot">=</span> batch_size_traffic,</span>
<span id="cb16-318"><a href="#cb16-318" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$offset"</span> <span class="ot">=</span> offset</span>
<span id="cb16-319"><a href="#cb16-319" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-320"><a href="#cb16-320" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-321"><a href="#cb16-321" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> req <span class="sc">|&gt;</span> <span class="fu">req_perform</span>()</span>
<span id="cb16-322"><a href="#cb16-322" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-323"><a href="#cb16-323" aria-hidden="true" tabindex="-1"></a>    raw_csv <span class="ot">&lt;-</span> resp <span class="sc">|&gt;</span> <span class="fu">resp_body_raw</span>()</span>
<span id="cb16-324"><a href="#cb16-324" aria-hidden="true" tabindex="-1"></a>    chunk   <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(raw_csv, <span class="at">col_types =</span> col_spec_traffic, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-325"><a href="#cb16-325" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-326"><a href="#cb16-326" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(chunk) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb16-327"><a href="#cb16-327" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"No more rows returned; finished traffic download."</span>)</span>
<span id="cb16-328"><a href="#cb16-328" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb16-329"><a href="#cb16-329" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-330"><a href="#cb16-330" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-331"><a href="#cb16-331" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write this batch immediately to disk</span></span>
<span id="cb16-332"><a href="#cb16-332" aria-hidden="true" tabindex="-1"></a>    out_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(</span>
<span id="cb16-333"><a href="#cb16-333" aria-hidden="true" tabindex="-1"></a>      batch_dir_traffic,</span>
<span id="cb16-334"><a href="#cb16-334" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">"nyc_traffic_counts_batch_%04d.csv"</span>, batch_id)</span>
<span id="cb16-335"><a href="#cb16-335" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-336"><a href="#cb16-336" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-337"><a href="#cb16-337" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(chunk, out_path)</span>
<span id="cb16-338"><a href="#cb16-338" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"  Traffic: retrieved %d rows and wrote '%s'."</span>, <span class="fu">nrow</span>(chunk), out_path))</span>
<span id="cb16-339"><a href="#cb16-339" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-340"><a href="#cb16-340" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(chunk) <span class="sc">&lt;</span> batch_size_traffic) {</span>
<span id="cb16-341"><a href="#cb16-341" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Traffic: last (partial) batch received; stopping."</span>)</span>
<span id="cb16-342"><a href="#cb16-342" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb16-343"><a href="#cb16-343" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-344"><a href="#cb16-344" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-345"><a href="#cb16-345" aria-hidden="true" tabindex="-1"></a>    offset   <span class="ot">&lt;-</span> offset <span class="sc">+</span> batch_size_traffic</span>
<span id="cb16-346"><a href="#cb16-346" aria-hidden="true" tabindex="-1"></a>    batch_id <span class="ot">&lt;-</span> batch_id <span class="sc">+</span> <span class="dv">1</span>L</span>
<span id="cb16-347"><a href="#cb16-347" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-348"><a href="#cb16-348" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="fl">0.25</span>)  <span class="co"># be polite to the API</span></span>
<span id="cb16-349"><a href="#cb16-349" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-350"><a href="#cb16-350" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-351"><a href="#cb16-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-352"><a href="#cb16-352" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-353"><a href="#cb16-353" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper: load and combine all traffic batches; optionally write final file</span></span>
<span id="cb16-354"><a href="#cb16-354" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-355"><a href="#cb16-355" aria-hidden="true" tabindex="-1"></a>load_all_traffic_batches <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">write_final =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb16-356"><a href="#cb16-356" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(batch_dir_traffic)) {</span>
<span id="cb16-357"><a href="#cb16-357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Traffic batch directory does not exist: "</span>, batch_dir_traffic)</span>
<span id="cb16-358"><a href="#cb16-358" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-359"><a href="#cb16-359" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-360"><a href="#cb16-360" aria-hidden="true" tabindex="-1"></a>  files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb16-361"><a href="#cb16-361" aria-hidden="true" tabindex="-1"></a>    batch_dir_traffic,</span>
<span id="cb16-362"><a href="#cb16-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">pattern   =</span> batch_pattern_traffic,</span>
<span id="cb16-363"><a href="#cb16-363" aria-hidden="true" tabindex="-1"></a>    <span class="at">full.names =</span> <span class="cn">TRUE</span></span>
<span id="cb16-364"><a href="#cb16-364" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-365"><a href="#cb16-365" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-366"><a href="#cb16-366" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb16-367"><a href="#cb16-367" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No traffic batch files found in: "</span>, batch_dir_traffic)</span>
<span id="cb16-368"><a href="#cb16-368" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-369"><a href="#cb16-369" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-370"><a href="#cb16-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Loading %d traffic batch files..."</span>, <span class="fu">length</span>(files)))</span>
<span id="cb16-371"><a href="#cb16-371" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-372"><a href="#cb16-372" aria-hidden="true" tabindex="-1"></a>  dfs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(files, <span class="cf">function</span>(f) {</span>
<span id="cb16-373"><a href="#cb16-373" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_csv</span>(f, <span class="at">col_types =</span> col_spec_traffic, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-374"><a href="#cb16-374" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb16-375"><a href="#cb16-375" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-376"><a href="#cb16-376" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dfs)</span>
<span id="cb16-377"><a href="#cb16-377" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-378"><a href="#cb16-378" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (write_final) {</span>
<span id="cb16-379"><a href="#cb16-379" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="fu">dirname</span>(final_file_traffic), <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-380"><a href="#cb16-380" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(df, final_file_traffic)</span>
<span id="cb16-381"><a href="#cb16-381" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Wrote combined traffic data to '%s'."</span>, final_file_traffic))</span>
<span id="cb16-382"><a href="#cb16-382" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-383"><a href="#cb16-383" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-384"><a href="#cb16-384" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb16-385"><a href="#cb16-385" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-386"><a href="#cb16-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-387"><a href="#cb16-387" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-388"><a href="#cb16-388" aria-hidden="true" tabindex="-1"></a><span class="co"># Main: use final traffic file if present; otherwise build it</span></span>
<span id="cb16-389"><a href="#cb16-389" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------</span></span>
<span id="cb16-390"><a href="#cb16-390" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(final_file_traffic)) {</span>
<span id="cb16-391"><a href="#cb16-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(</span>
<span id="cb16-392"><a href="#cb16-392" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Final traffic file '%s' exists. Loading for analysis..."</span>,</span>
<span id="cb16-393"><a href="#cb16-393" aria-hidden="true" tabindex="-1"></a>    final_file_traffic</span>
<span id="cb16-394"><a href="#cb16-394" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb16-395"><a href="#cb16-395" aria-hidden="true" tabindex="-1"></a>  traffic_counts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb16-396"><a href="#cb16-396" aria-hidden="true" tabindex="-1"></a>    final_file_traffic,</span>
<span id="cb16-397"><a href="#cb16-397" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_types =</span> col_spec_traffic,</span>
<span id="cb16-398"><a href="#cb16-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_col_types =</span> <span class="cn">FALSE</span></span>
<span id="cb16-399"><a href="#cb16-399" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-400"><a href="#cb16-400" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb16-401"><a href="#cb16-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(</span>
<span id="cb16-402"><a href="#cb16-402" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Final traffic file '%s' not found. Ensuring batches are downloaded..."</span>,</span>
<span id="cb16-403"><a href="#cb16-403" aria-hidden="true" tabindex="-1"></a>    final_file_traffic</span>
<span id="cb16-404"><a href="#cb16-404" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb16-405"><a href="#cb16-405" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-406"><a href="#cb16-406" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This will resume from whatever batches you already have</span></span>
<span id="cb16-407"><a href="#cb16-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download_traffic_batches</span>()</span>
<span id="cb16-408"><a href="#cb16-408" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-409"><a href="#cb16-409" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load all batches, write final file, and return combined df</span></span>
<span id="cb16-410"><a href="#cb16-410" aria-hidden="true" tabindex="-1"></a>  traffic_counts <span class="ot">&lt;-</span> <span class="fu">load_all_traffic_batches</span>(<span class="at">write_final =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-411"><a href="#cb16-411" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-412"><a href="#cb16-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-413"><a href="#cb16-413" aria-hidden="true" tabindex="-1"></a><span class="co"># ready for analysis</span></span>
<span id="cb16-414"><a href="#cb16-414" aria-hidden="true" tabindex="-1"></a><span class="co"># str(traffic_counts)</span></span>
<span id="cb16-415"><a href="#cb16-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-416"><a href="#cb16-416" aria-hidden="true" tabindex="-1"></a>traffic_counts_2024 <span class="ot">&lt;-</span> traffic_counts <span class="sc">%&gt;%</span></span>
<span id="cb16-417"><a href="#cb16-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(yr <span class="sc">==</span> <span class="st">"2024"</span>)</span>
<span id="cb16-418"><a href="#cb16-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-419"><a href="#cb16-419" aria-hidden="true" tabindex="-1"></a>traffic_monthly <span class="ot">&lt;-</span> traffic_counts <span class="sc">%&gt;%</span></span>
<span id="cb16-420"><a href="#cb16-420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-421"><a href="#cb16-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">yr =</span> <span class="fu">as.integer</span>(yr),</span>
<span id="cb16-422"><a href="#cb16-422" aria-hidden="true" tabindex="-1"></a>    <span class="at">m  =</span> <span class="fu">as.integer</span>(m),</span>
<span id="cb16-423"><a href="#cb16-423" aria-hidden="true" tabindex="-1"></a>    <span class="at">vol =</span> <span class="fu">as.numeric</span>(vol)</span>
<span id="cb16-424"><a href="#cb16-424" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-425"><a href="#cb16-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(yr <span class="sc">==</span> <span class="dv">2025</span>) <span class="sc">%&gt;%</span>          <span class="co"># only 2024 if desired</span></span>
<span id="cb16-426"><a href="#cb16-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(boro, m) <span class="sc">%&gt;%</span>           <span class="co"># group by borough + month</span></span>
<span id="cb16-427"><a href="#cb16-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb16-428"><a href="#cb16-428" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_volume =</span> <span class="fu">sum</span>(vol, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-429"><a href="#cb16-429" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_records =</span> <span class="fu">n</span>()</span>
<span id="cb16-430"><a href="#cb16-430" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-431"><a href="#cb16-431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(boro, m)</span>
<span id="cb16-432"><a href="#cb16-432" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-433"><a href="#cb16-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-434"><a href="#cb16-434" aria-hidden="true" tabindex="-1"></a>The 311 dataset is incredibly large. This was one of the biggest reason why we decided to focus on the 2024 year only, as downloading just this year took about 15 minutes. The strategy when downloading the data is to do it once and never again. This means that when we download the data we save it in folder called data so next time we can just read locally. We do not just write the final file, we write each batch, just in case the download interrupts, we can continue where we left off. This is not as necessary for comfort when it comes to the traffic dataset, however the same strategy is applied there, because being kind to th api is important. </span>
<span id="cb16-435"><a href="#cb16-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-436"><a href="#cb16-436" aria-hidden="true" tabindex="-1"></a><span class="fu">## Street Level Analysis</span></span>
<span id="cb16-437"><a href="#cb16-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-440"><a href="#cb16-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-441"><a href="#cb16-441" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "CODE: Mapping NYC 311 Complaints"</span></span>
<span id="cb16-442"><a href="#cb16-442" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-443"><a href="#cb16-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-444"><a href="#cb16-444" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-445"><a href="#cb16-445" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Normalize 311 column names</span></span>
<span id="cb16-446"><a href="#cb16-446" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-447"><a href="#cb16-447" aria-hidden="true" tabindex="-1"></a>df311 <span class="ot">&lt;-</span> data_311_2024</span>
<span id="cb16-448"><a href="#cb16-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-449"><a href="#cb16-449" aria-hidden="true" tabindex="-1"></a>df311 <span class="ot">&lt;-</span> df311 <span class="sc">|&gt;</span></span>
<span id="cb16-450"><a href="#cb16-450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-451"><a href="#cb16-451" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitude =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(longitude)),</span>
<span id="cb16-452"><a href="#cb16-452" aria-hidden="true" tabindex="-1"></a>    <span class="at">latitude  =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(latitude))</span>
<span id="cb16-453"><a href="#cb16-453" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-454"><a href="#cb16-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-455"><a href="#cb16-455" aria-hidden="true" tabindex="-1"></a><span class="co"># keep only plausible NYC coords </span></span>
<span id="cb16-456"><a href="#cb16-456" aria-hidden="true" tabindex="-1"></a>df311 <span class="ot">&lt;-</span> df311 <span class="sc">|&gt;</span></span>
<span id="cb16-457"><a href="#cb16-457" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb16-458"><a href="#cb16-458" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(longitude) <span class="sc">|</span> (longitude <span class="sc">&gt;=</span> <span class="sc">-</span><span class="fl">74.3</span> <span class="sc">&amp;</span> longitude <span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">73.6</span>),</span>
<span id="cb16-459"><a href="#cb16-459" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(latitude)  <span class="sc">|</span> (latitude  <span class="sc">&gt;=</span>  <span class="fl">40.45</span> <span class="sc">&amp;</span> latitude  <span class="sc">&lt;=</span> <span class="fl">40.95</span>)</span>
<span id="cb16-460"><a href="#cb16-460" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-461"><a href="#cb16-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-462"><a href="#cb16-462" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-463"><a href="#cb16-463" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Load NYC boundaries</span></span>
<span id="cb16-464"><a href="#cb16-464" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-465"><a href="#cb16-465" aria-hidden="true" tabindex="-1"></a>relevant_complaints <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Noise - Vehicle"</span>, <span class="st">"Illegal Parking"</span>, <span class="st">"Blocked Driveway"</span>, <span class="st">"Traffic Signal Condition"</span>, <span class="st">"Street Condition"</span>, <span class="st">"Street Light Condition"</span>, <span class="st">"Street Sign - Damaged"</span>, <span class="st">"Street Sign - Dangling"</span>, <span class="st">"Street Sign - Missing"</span>, <span class="st">"Noise - Street/Sidewalk"</span>, <span class="st">"Highway Sign - Missing"</span>, <span class="st">"Bridge Condition"</span>, <span class="st">"Abandoned Vehicle"</span>)</span>
<span id="cb16-466"><a href="#cb16-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-467"><a href="#cb16-467" aria-hidden="true" tabindex="-1"></a>boroughs_url <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/gthc-hcne.geojson"</span></span>
<span id="cb16-468"><a href="#cb16-468" aria-hidden="true" tabindex="-1"></a>modzcta_url  <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/pri4-ifjk.geojson"</span></span>
<span id="cb16-469"><a href="#cb16-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-470"><a href="#cb16-470" aria-hidden="true" tabindex="-1"></a>nyc_boroughs <span class="ot">&lt;-</span> <span class="fu">st_read</span>(boroughs_url, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">st_make_valid</span>()</span>
<span id="cb16-471"><a href="#cb16-471" aria-hidden="true" tabindex="-1"></a>nyc_outline  <span class="ot">&lt;-</span> <span class="fu">st_union</span>(nyc_boroughs)</span>
<span id="cb16-472"><a href="#cb16-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-473"><a href="#cb16-473" aria-hidden="true" tabindex="-1"></a>nyc_modzcta  <span class="ot">&lt;-</span> <span class="fu">st_read</span>(modzcta_url, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">st_make_valid</span>()</span>
<span id="cb16-474"><a href="#cb16-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-475"><a href="#cb16-475" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-476"><a href="#cb16-476" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) All Noise - Vehicle complaints (points)</span></span>
<span id="cb16-477"><a href="#cb16-477" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-478"><a href="#cb16-478" aria-hidden="true" tabindex="-1"></a>noise_vehicle_all <span class="ot">&lt;-</span> df311 <span class="sc">|&gt;</span></span>
<span id="cb16-479"><a href="#cb16-479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(complaint_type <span class="sc">%in%</span> relevant_complaints ) <span class="sc">|&gt;</span></span>
<span id="cb16-480"><a href="#cb16-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude), <span class="sc">!</span><span class="fu">is.na</span>(latitude)) <span class="sc">|&gt;</span></span>
<span id="cb16-481"><a href="#cb16-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(borough), borough <span class="sc">!=</span> <span class="st">"Unspecified"</span>)</span>
<span id="cb16-482"><a href="#cb16-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-483"><a href="#cb16-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-484"><a href="#cb16-484" aria-hidden="true" tabindex="-1"></a>noise_vehicle_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(</span>
<span id="cb16-485"><a href="#cb16-485" aria-hidden="true" tabindex="-1"></a>  noise_vehicle_all,</span>
<span id="cb16-486"><a href="#cb16-486" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>),</span>
<span id="cb16-487"><a href="#cb16-487" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="dv">4326</span>,</span>
<span id="cb16-488"><a href="#cb16-488" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb16-489"><a href="#cb16-489" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-490"><a href="#cb16-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-491"><a href="#cb16-491" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-492"><a href="#cb16-492" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Top intersection per borough (INTERSECTION only)</span></span>
<span id="cb16-493"><a href="#cb16-493" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-494"><a href="#cb16-494" aria-hidden="true" tabindex="-1"></a>top_intersections <span class="ot">&lt;-</span> df311 <span class="sc">|&gt;</span></span>
<span id="cb16-495"><a href="#cb16-495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(complaint_type <span class="sc">==</span> <span class="st">"Noise - Vehicle"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-496"><a href="#cb16-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(borough), borough <span class="sc">!=</span> <span class="st">"Unspecified"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-497"><a href="#cb16-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_to_upper</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(address_type))) <span class="sc">==</span> <span class="st">"INTERSECTION"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-498"><a href="#cb16-498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-499"><a href="#cb16-499" aria-hidden="true" tabindex="-1"></a>    <span class="at">s1 =</span> <span class="fu">na_if</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(intersection_street_1)), <span class="st">""</span>),</span>
<span id="cb16-500"><a href="#cb16-500" aria-hidden="true" tabindex="-1"></a>    <span class="at">s2 =</span> <span class="fu">na_if</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(intersection_street_2)), <span class="st">""</span>)</span>
<span id="cb16-501"><a href="#cb16-501" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb16-502"><a href="#cb16-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(s1), <span class="sc">!</span><span class="fu">is.na</span>(s2)) <span class="sc">|&gt;</span></span>
<span id="cb16-503"><a href="#cb16-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-504"><a href="#cb16-504" aria-hidden="true" tabindex="-1"></a>    <span class="at">a =</span> <span class="fu">pmin</span>(s1, s2),</span>
<span id="cb16-505"><a href="#cb16-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">b =</span> <span class="fu">pmax</span>(s1, s2),</span>
<span id="cb16-506"><a href="#cb16-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">intersection =</span> <span class="fu">paste</span>(a, b, <span class="at">sep =</span> <span class="st">" &amp; "</span>)</span>
<span id="cb16-507"><a href="#cb16-507" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb16-508"><a href="#cb16-508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(borough, intersection, <span class="at">name =</span> <span class="st">"total_complaints"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-509"><a href="#cb16-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(borough) <span class="sc">|&gt;</span></span>
<span id="cb16-510"><a href="#cb16-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(total_complaints, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-511"><a href="#cb16-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb16-512"><a href="#cb16-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-513"><a href="#cb16-513" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-514"><a href="#cb16-514" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Attach coordinates for those top intersections</span></span>
<span id="cb16-515"><a href="#cb16-515" aria-hidden="true" tabindex="-1"></a><span class="co">#    (mean lat/lon of matching complaints, now numeric)</span></span>
<span id="cb16-516"><a href="#cb16-516" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-517"><a href="#cb16-517" aria-hidden="true" tabindex="-1"></a>top_intersections_geo <span class="ot">&lt;-</span> df311 <span class="sc">|&gt;</span></span>
<span id="cb16-518"><a href="#cb16-518" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(complaint_type <span class="sc">==</span> <span class="st">"Noise - Vehicle"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-519"><a href="#cb16-519" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(borough), borough <span class="sc">!=</span> <span class="st">"Unspecified"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-520"><a href="#cb16-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_to_upper</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(address_type))) <span class="sc">==</span> <span class="st">"INTERSECTION"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-521"><a href="#cb16-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude), <span class="sc">!</span><span class="fu">is.na</span>(latitude)) <span class="sc">|&gt;</span></span>
<span id="cb16-522"><a href="#cb16-522" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-523"><a href="#cb16-523" aria-hidden="true" tabindex="-1"></a>    <span class="at">s1 =</span> <span class="fu">na_if</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(intersection_street_1)), <span class="st">""</span>),</span>
<span id="cb16-524"><a href="#cb16-524" aria-hidden="true" tabindex="-1"></a>    <span class="at">s2 =</span> <span class="fu">na_if</span>(<span class="fu">str_squish</span>(<span class="fu">as.character</span>(intersection_street_2)), <span class="st">""</span>),</span>
<span id="cb16-525"><a href="#cb16-525" aria-hidden="true" tabindex="-1"></a>    <span class="at">a  =</span> <span class="fu">pmin</span>(s1, s2),</span>
<span id="cb16-526"><a href="#cb16-526" aria-hidden="true" tabindex="-1"></a>    <span class="at">b  =</span> <span class="fu">pmax</span>(s1, s2),</span>
<span id="cb16-527"><a href="#cb16-527" aria-hidden="true" tabindex="-1"></a>    <span class="at">intersection =</span> <span class="fu">paste</span>(a, b, <span class="at">sep =</span> <span class="st">" &amp; "</span>)</span>
<span id="cb16-528"><a href="#cb16-528" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb16-529"><a href="#cb16-529" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(top_intersections, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"borough"</span>, <span class="st">"intersection"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb16-530"><a href="#cb16-530" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(borough, intersection, total_complaints) <span class="sc">|&gt;</span></span>
<span id="cb16-531"><a href="#cb16-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb16-532"><a href="#cb16-532" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitude =</span> <span class="fu">mean</span>(longitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-533"><a href="#cb16-533" aria-hidden="true" tabindex="-1"></a>    <span class="at">latitude  =</span> <span class="fu">mean</span>(latitude,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-534"><a href="#cb16-534" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb16-535"><a href="#cb16-535" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb16-536"><a href="#cb16-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude), <span class="sc">!</span><span class="fu">is.na</span>(latitude))   <span class="co"># ensure valid coords</span></span>
<span id="cb16-537"><a href="#cb16-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-538"><a href="#cb16-538" aria-hidden="true" tabindex="-1"></a>top_intersections_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(</span>
<span id="cb16-539"><a href="#cb16-539" aria-hidden="true" tabindex="-1"></a>  top_intersections_geo,</span>
<span id="cb16-540"><a href="#cb16-540" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>),</span>
<span id="cb16-541"><a href="#cb16-541" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="dv">4326</span>,</span>
<span id="cb16-542"><a href="#cb16-542" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb16-543"><a href="#cb16-543" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-544"><a href="#cb16-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-545"><a href="#cb16-545" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-546"><a href="#cb16-546" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) CRS alignment</span></span>
<span id="cb16-547"><a href="#cb16-547" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-548"><a href="#cb16-548" aria-hidden="true" tabindex="-1"></a>target_crs <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(nyc_outline)</span>
<span id="cb16-549"><a href="#cb16-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-550"><a href="#cb16-550" aria-hidden="true" tabindex="-1"></a>nyc_outline_aligned  <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(nyc_outline, target_crs)</span>
<span id="cb16-551"><a href="#cb16-551" aria-hidden="true" tabindex="-1"></a>nyc_modzcta_aligned  <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(nyc_modzcta, target_crs)</span>
<span id="cb16-552"><a href="#cb16-552" aria-hidden="true" tabindex="-1"></a>noise_points_aligned <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(noise_vehicle_sf, target_crs)</span>
<span id="cb16-553"><a href="#cb16-553" aria-hidden="true" tabindex="-1"></a>top_points_aligned   <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(top_intersections_sf, target_crs)</span>
<span id="cb16-554"><a href="#cb16-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-555"><a href="#cb16-555" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-556"><a href="#cb16-556" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Labels</span></span>
<span id="cb16-557"><a href="#cb16-557" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-558"><a href="#cb16-558" aria-hidden="true" tabindex="-1"></a>top_points_aligned <span class="ot">&lt;-</span> top_points_aligned <span class="sc">|&gt;</span></span>
<span id="cb16-559"><a href="#cb16-559" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">paste0</span>(intersection, <span class="st">" ("</span>, total_complaints, <span class="st">")"</span>))</span>
<span id="cb16-560"><a href="#cb16-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-561"><a href="#cb16-561" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-562"><a href="#cb16-562" aria-hidden="true" tabindex="-1"></a><span class="co"># 7) Final map</span></span>
<span id="cb16-563"><a href="#cb16-563" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------------------------------</span></span>
<span id="cb16-564"><a href="#cb16-564" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-565"><a href="#cb16-565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> nyc_outline_aligned,</span>
<span id="cb16-566"><a href="#cb16-566" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">"grey90"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.35</span>) <span class="sc">+</span></span>
<span id="cb16-567"><a href="#cb16-567" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> nyc_modzcta_aligned,</span>
<span id="cb16-568"><a href="#cb16-568" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"grey60"</span>, <span class="at">linewidth =</span> <span class="fl">0.20</span>) <span class="sc">+</span></span>
<span id="cb16-569"><a href="#cb16-569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> noise_points_aligned,</span>
<span id="cb16-570"><a href="#cb16-570" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb16-571"><a href="#cb16-571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> top_points_aligned,</span>
<span id="cb16-572"><a href="#cb16-572" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">color =</span> borough),</span>
<span id="cb16-573"><a href="#cb16-573" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb16-574"><a href="#cb16-574" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Dark2"</span>) <span class="sc">+</span></span>
<span id="cb16-575"><a href="#cb16-575" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb16-576"><a href="#cb16-576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-577"><a href="#cb16-577" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"NYC 311 Noise – Vehicle Complaints (2024)"</span>,</span>
<span id="cb16-578"><a href="#cb16-578" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Highlighted dots show the most-reported INTERSECTION per borough"</span>,</span>
<span id="cb16-579"><a href="#cb16-579" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Borough"</span>,</span>
<span id="cb16-580"><a href="#cb16-580" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span></span>
<span id="cb16-581"><a href="#cb16-581" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-582"><a href="#cb16-582" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-583"><a href="#cb16-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-586"><a href="#cb16-586" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-587"><a href="#cb16-587" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: Number of Complaints by Borough</span></span>
<span id="cb16-588"><a href="#cb16-588" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-589"><a href="#cb16-589" aria-hidden="true" tabindex="-1"></a>vehicle_related_issues_by_borough <span class="ot">&lt;-</span> df311 <span class="sc">%&gt;%</span></span>
<span id="cb16-590"><a href="#cb16-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(complaint_type <span class="sc">%in%</span> relevant_complaints) <span class="sc">%&gt;%</span></span>
<span id="cb16-591"><a href="#cb16-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(borough), borough <span class="sc">!=</span> <span class="st">"Unspecified"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-592"><a href="#cb16-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(borough, <span class="at">name =</span> <span class="st">"total_complaints"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-593"><a href="#cb16-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_complaints))</span>
<span id="cb16-594"><a href="#cb16-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-595"><a href="#cb16-595" aria-hidden="true" tabindex="-1"></a><span class="fu">format_numbers_kable</span>(vehicle_related_issues_by_borough, <span class="at">decimals =</span> <span class="dv">0</span>)</span>
<span id="cb16-596"><a href="#cb16-596" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-597"><a href="#cb16-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-598"><a href="#cb16-598" aria-hidden="true" tabindex="-1"></a>First I want to explain the purpose of the chart, it's meant to give a better representation of what the numbers mean. Its hard to look at just some number and really understand the scale and severity of these issues. If you were to just look at the number, you may think that this is not a huge problem in Manhattan, after all its the 4th spot on the list. Yet after looking at the map, it looks like someone painted manhattan with a brush.</span>
<span id="cb16-599"><a href="#cb16-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-600"><a href="#cb16-600" aria-hidden="true" tabindex="-1"></a>I want to point out that I am not using all of the complaints here. I am selecting only relevant complaints, for a complete list, look into the "relevant_complaints" variable from the code block under "CODE: Mapping NYC 311 Complaints". </span>
<span id="cb16-601"><a href="#cb16-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-604"><a href="#cb16-604" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-605"><a href="#cb16-605" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: Top Intersections</span></span>
<span id="cb16-606"><a href="#cb16-606" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-607"><a href="#cb16-607" aria-hidden="true" tabindex="-1"></a>top_sorted <span class="ot">&lt;-</span> top_intersections <span class="sc">%&gt;%</span></span>
<span id="cb16-608"><a href="#cb16-608" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">as.numeric</span>(total_complaints)))</span>
<span id="cb16-609"><a href="#cb16-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-610"><a href="#cb16-610" aria-hidden="true" tabindex="-1"></a><span class="fu">format_numbers_kable</span>(top_sorted, <span class="at">decimals =</span> <span class="dv">0</span>)</span>
<span id="cb16-611"><a href="#cb16-611" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-612"><a href="#cb16-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-613"><a href="#cb16-613" aria-hidden="true" tabindex="-1"></a>The following are the busiest intersection in each borough. These data points can also be seen on the map, they are the big dots placed. What I find most interesting is **7 AVENUE &amp; WEST 53 STREET**, given that it's dead center. While Manhattan receives one of the smallest number of total relevant complaints, it's impacted by it more due to how congested it is. Given this, we can predict that traffic flow and complaints will flow more fluently together then in other boroughs. Lets test this hypothesis. </span>
<span id="cb16-614"><a href="#cb16-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-615"><a href="#cb16-615" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hour Hotspots of Traffic and Complaints</span></span>
<span id="cb16-616"><a href="#cb16-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-617"><a href="#cb16-617" aria-hidden="true" tabindex="-1"></a>For this section we will look into borough level, hourly hotspots throughout the 2024 year. The traffic dataset does not have every month for each borough, but the hourly data is very reliable. We will plot these data points to see how the boroughs and different type of complaints may relate to traffic. </span>
<span id="cb16-618"><a href="#cb16-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-621"><a href="#cb16-621" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-622"><a href="#cb16-622" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: Compute Hourly Data</span></span>
<span id="cb16-623"><a href="#cb16-623" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-624"><a href="#cb16-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-625"><a href="#cb16-625" aria-hidden="true" tabindex="-1"></a>complaints_hourly <span class="ot">&lt;-</span> data_311_2024 <span class="sc">%&gt;%</span></span>
<span id="cb16-626"><a href="#cb16-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(created_date, complaint_type, borough) <span class="sc">%&gt;%</span></span>
<span id="cb16-627"><a href="#cb16-627" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-628"><a href="#cb16-628" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure created_date is parsed correctly</span></span>
<span id="cb16-629"><a href="#cb16-629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-630"><a href="#cb16-630" aria-hidden="true" tabindex="-1"></a>    <span class="at">created_date =</span> <span class="fu">ymd_hms</span>(created_date, <span class="at">tz =</span> <span class="st">"UTC"</span>),</span>
<span id="cb16-631"><a href="#cb16-631" aria-hidden="true" tabindex="-1"></a>    <span class="at">exact_hour   =</span> <span class="fu">as.integer</span>(<span class="fu">hour</span>(created_date)),</span>
<span id="cb16-632"><a href="#cb16-632" aria-hidden="true" tabindex="-1"></a>    <span class="at">borough =</span> <span class="fu">str_to_title</span>(<span class="fu">str_trim</span>(borough))</span>
<span id="cb16-633"><a href="#cb16-633" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-634"><a href="#cb16-634" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-635"><a href="#cb16-635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(</span>
<span id="cb16-636"><a href="#cb16-636" aria-hidden="true" tabindex="-1"></a>    exact_hour,</span>
<span id="cb16-637"><a href="#cb16-637" aria-hidden="true" tabindex="-1"></a>    borough,</span>
<span id="cb16-638"><a href="#cb16-638" aria-hidden="true" tabindex="-1"></a>    complaint_type</span>
<span id="cb16-639"><a href="#cb16-639" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-640"><a href="#cb16-640" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-641"><a href="#cb16-641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb16-642"><a href="#cb16-642" aria-hidden="true" tabindex="-1"></a>    <span class="at">complaint_count =</span> <span class="fu">n</span>(),</span>
<span id="cb16-643"><a href="#cb16-643" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb16-644"><a href="#cb16-644" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-645"><a href="#cb16-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-646"><a href="#cb16-646" aria-hidden="true" tabindex="-1"></a>traffic_hourly <span class="ot">&lt;-</span> traffic_counts <span class="sc">%&gt;%</span></span>
<span id="cb16-647"><a href="#cb16-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-648"><a href="#cb16-648" aria-hidden="true" tabindex="-1"></a>    <span class="at">exact_hour =</span> <span class="fu">as.integer</span>(hh),</span>
<span id="cb16-649"><a href="#cb16-649" aria-hidden="true" tabindex="-1"></a>    <span class="at">borough =</span> <span class="fu">str_to_title</span>(<span class="fu">str_trim</span>(boro)),</span>
<span id="cb16-650"><a href="#cb16-650" aria-hidden="true" tabindex="-1"></a>    <span class="at">vol        =</span> <span class="fu">as.numeric</span>(vol)</span>
<span id="cb16-651"><a href="#cb16-651" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-652"><a href="#cb16-652" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-653"><a href="#cb16-653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(</span>
<span id="cb16-654"><a href="#cb16-654" aria-hidden="true" tabindex="-1"></a>    exact_hour,</span>
<span id="cb16-655"><a href="#cb16-655" aria-hidden="true" tabindex="-1"></a>    borough</span>
<span id="cb16-656"><a href="#cb16-656" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-657"><a href="#cb16-657" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-658"><a href="#cb16-658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb16-659"><a href="#cb16-659" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_traffic_volume =</span> <span class="fu">mean</span>(vol, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-660"><a href="#cb16-660" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb16-661"><a href="#cb16-661" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-662"><a href="#cb16-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-663"><a href="#cb16-663" aria-hidden="true" tabindex="-1"></a>complaints_traffic_joined <span class="ot">&lt;-</span> complaints_hourly <span class="sc">%&gt;%</span></span>
<span id="cb16-664"><a href="#cb16-664" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb16-665"><a href="#cb16-665" aria-hidden="true" tabindex="-1"></a>    traffic_hourly,</span>
<span id="cb16-666"><a href="#cb16-666" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"exact_hour"</span>, <span class="st">"borough"</span>)</span>
<span id="cb16-667"><a href="#cb16-667" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-668"><a href="#cb16-668" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-669"><a href="#cb16-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-670"><a href="#cb16-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-671"><a href="#cb16-671" aria-hidden="true" tabindex="-1"></a>The traffic dataset already has a hourly column but for the 311 dataset we must extract the hour. After the extraction is completed, we group by borough and hour, then we can join the two dataset with those fields respectively. </span>
<span id="cb16-672"><a href="#cb16-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-673"><a href="#cb16-673" aria-hidden="true" tabindex="-1"></a>I have decided to keep complaints as a count (total), while the traffic is average. The reasoning is due to some complaint types being very low in volume, and a count is a better representation.</span>
<span id="cb16-674"><a href="#cb16-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-677"><a href="#cb16-677" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-678"><a href="#cb16-678" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: Function to Plot Any Given Borough</span></span>
<span id="cb16-679"><a href="#cb16-679" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-680"><a href="#cb16-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-681"><a href="#cb16-681" aria-hidden="true" tabindex="-1"></a>plot_complaints_vs_traffic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, complaint_types, borough_name) {</span>
<span id="cb16-682"><a href="#cb16-682" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-683"><a href="#cb16-683" aria-hidden="true" tabindex="-1"></a>  boro <span class="ot">&lt;-</span> <span class="fu">str_to_title</span>(<span class="fu">str_trim</span>(borough_name))</span>
<span id="cb16-684"><a href="#cb16-684" aria-hidden="true" tabindex="-1"></a>  complaint_types <span class="ot">&lt;-</span> <span class="fu">as.character</span>(complaint_types)</span>
<span id="cb16-685"><a href="#cb16-685" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-686"><a href="#cb16-686" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb16-687"><a href="#cb16-687" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb16-688"><a href="#cb16-688" aria-hidden="true" tabindex="-1"></a>      <span class="at">borough =</span> <span class="fu">str_to_title</span>(<span class="fu">str_trim</span>(borough)),</span>
<span id="cb16-689"><a href="#cb16-689" aria-hidden="true" tabindex="-1"></a>      <span class="at">exact_hour =</span> <span class="fu">as.integer</span>(exact_hour)</span>
<span id="cb16-690"><a href="#cb16-690" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb16-691"><a href="#cb16-691" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb16-692"><a href="#cb16-692" aria-hidden="true" tabindex="-1"></a>      borough <span class="sc">==</span> boro,</span>
<span id="cb16-693"><a href="#cb16-693" aria-hidden="true" tabindex="-1"></a>      complaint_type <span class="sc">%in%</span> complaint_types</span>
<span id="cb16-694"><a href="#cb16-694" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb16-695"><a href="#cb16-695" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(exact_hour, borough) <span class="sc">%&gt;%</span></span>
<span id="cb16-696"><a href="#cb16-696" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb16-697"><a href="#cb16-697" aria-hidden="true" tabindex="-1"></a>      <span class="at">complaint_count =</span> <span class="fu">sum</span>(complaint_count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-698"><a href="#cb16-698" aria-hidden="true" tabindex="-1"></a>      <span class="at">avg_traffic_volume =</span> <span class="fu">mean</span>(avg_traffic_volume, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-699"><a href="#cb16-699" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb16-700"><a href="#cb16-700" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb16-701"><a href="#cb16-701" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(exact_hour)</span>
<span id="cb16-702"><a href="#cb16-702" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-703"><a href="#cb16-703" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(df) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb16-704"><a href="#cb16-704" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No rows after filtering. Check borough name and complaint types."</span>)</span>
<span id="cb16-705"><a href="#cb16-705" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-706"><a href="#cb16-706" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-707"><a href="#cb16-707" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scale factor for dual axis</span></span>
<span id="cb16-708"><a href="#cb16-708" aria-hidden="true" tabindex="-1"></a>  max_c <span class="ot">&lt;-</span> <span class="fu">max</span>(df<span class="sc">$</span>complaint_count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-709"><a href="#cb16-709" aria-hidden="true" tabindex="-1"></a>  max_v <span class="ot">&lt;-</span> <span class="fu">max</span>(df<span class="sc">$</span>avg_traffic_volume, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-710"><a href="#cb16-710" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-711"><a href="#cb16-711" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.finite</span>(max_v) <span class="sc">||</span> max_v <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb16-712"><a href="#cb16-712" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"avg_traffic_volume is all NA/0 after filtering; cannot scale secondary axis."</span>)</span>
<span id="cb16-713"><a href="#cb16-713" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-714"><a href="#cb16-714" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-715"><a href="#cb16-715" aria-hidden="true" tabindex="-1"></a>  scale_factor <span class="ot">&lt;-</span> max_c <span class="sc">/</span> max_v</span>
<span id="cb16-716"><a href="#cb16-716" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-717"><a href="#cb16-717" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Long format just for plotting clarity</span></span>
<span id="cb16-718"><a href="#cb16-718" aria-hidden="true" tabindex="-1"></a>  plot_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb16-719"><a href="#cb16-719" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">%&gt;%</span></span>
<span id="cb16-720"><a href="#cb16-720" aria-hidden="true" tabindex="-1"></a>      <span class="fu">transmute</span>(</span>
<span id="cb16-721"><a href="#cb16-721" aria-hidden="true" tabindex="-1"></a>        exact_hour,</span>
<span id="cb16-722"><a href="#cb16-722" aria-hidden="true" tabindex="-1"></a>        <span class="at">value =</span> complaint_count,</span>
<span id="cb16-723"><a href="#cb16-723" aria-hidden="true" tabindex="-1"></a>        <span class="at">series =</span> <span class="st">"Complaint count"</span></span>
<span id="cb16-724"><a href="#cb16-724" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb16-725"><a href="#cb16-725" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">%&gt;%</span></span>
<span id="cb16-726"><a href="#cb16-726" aria-hidden="true" tabindex="-1"></a>      <span class="fu">transmute</span>(</span>
<span id="cb16-727"><a href="#cb16-727" aria-hidden="true" tabindex="-1"></a>        exact_hour,</span>
<span id="cb16-728"><a href="#cb16-728" aria-hidden="true" tabindex="-1"></a>        <span class="at">value =</span> avg_traffic_volume <span class="sc">*</span> scale_factor,</span>
<span id="cb16-729"><a href="#cb16-729" aria-hidden="true" tabindex="-1"></a>        <span class="at">series =</span> <span class="st">"Average traffic volume"</span></span>
<span id="cb16-730"><a href="#cb16-730" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-731"><a href="#cb16-731" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-732"><a href="#cb16-732" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-733"><a href="#cb16-733" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x =</span> exact_hour, <span class="at">y =</span> value, <span class="at">color =</span> series, <span class="at">linetype =</span> series)) <span class="sc">+</span></span>
<span id="cb16-734"><a href="#cb16-734" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb16-735"><a href="#cb16-735" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb16-736"><a href="#cb16-736" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">23</span>) <span class="sc">+</span></span>
<span id="cb16-737"><a href="#cb16-737" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb16-738"><a href="#cb16-738" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Complaint count (sum across selected types)"</span>,</span>
<span id="cb16-739"><a href="#cb16-739" aria-hidden="true" tabindex="-1"></a>      <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(</span>
<span id="cb16-740"><a href="#cb16-740" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> . <span class="sc">/</span> scale_factor,</span>
<span id="cb16-741"><a href="#cb16-741" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">"Average traffic volume"</span></span>
<span id="cb16-742"><a href="#cb16-742" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-743"><a href="#cb16-743" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb16-744"><a href="#cb16-744" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb16-745"><a href="#cb16-745" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb16-746"><a href="#cb16-746" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Complaint count"</span> <span class="ot">=</span> <span class="st">"#1f77b4"</span>,</span>
<span id="cb16-747"><a href="#cb16-747" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Average traffic volume"</span> <span class="ot">=</span> <span class="st">"#d62728"</span></span>
<span id="cb16-748"><a href="#cb16-748" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-749"><a href="#cb16-749" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb16-750"><a href="#cb16-750" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(</span>
<span id="cb16-751"><a href="#cb16-751" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb16-752"><a href="#cb16-752" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Complaint count"</span> <span class="ot">=</span> <span class="st">"solid"</span>,</span>
<span id="cb16-753"><a href="#cb16-753" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Average traffic volume"</span> <span class="ot">=</span> <span class="st">"dashed"</span></span>
<span id="cb16-754"><a href="#cb16-754" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-755"><a href="#cb16-755" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb16-756"><a href="#cb16-756" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb16-757"><a href="#cb16-757" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Complaints vs Traffic Volume —"</span>, boro),</span>
<span id="cb16-758"><a href="#cb16-758" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Complaint types:"</span>, <span class="fu">paste</span>(complaint_types, <span class="at">collapse =</span> <span class="st">", "</span>)),</span>
<span id="cb16-759"><a href="#cb16-759" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Hour of day (0–23)"</span>,</span>
<span id="cb16-760"><a href="#cb16-760" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="cn">NULL</span>,</span>
<span id="cb16-761"><a href="#cb16-761" aria-hidden="true" tabindex="-1"></a>      <span class="at">linetype =</span> <span class="cn">NULL</span></span>
<span id="cb16-762"><a href="#cb16-762" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb16-763"><a href="#cb16-763" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>) <span class="sc">+</span></span>
<span id="cb16-764"><a href="#cb16-764" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb16-765"><a href="#cb16-765" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb16-766"><a href="#cb16-766" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb16-767"><a href="#cb16-767" aria-hidden="true" tabindex="-1"></a>      <span class="at">aspect.ratio =</span> <span class="fl">0.45</span>   </span>
<span id="cb16-768"><a href="#cb16-768" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-769"><a href="#cb16-769" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-770"><a href="#cb16-770" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-771"><a href="#cb16-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-772"><a href="#cb16-772" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Vehicle - Noise</span></span>
<span id="cb16-775"><a href="#cb16-775" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-776"><a href="#cb16-776" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: Queens Vehicle - Noise</span></span>
<span id="cb16-777"><a href="#cb16-777" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-778"><a href="#cb16-778" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb16-779"><a href="#cb16-779" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb16-780"><a href="#cb16-780" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> <span class="fu">c</span>(<span class="st">"Noise - Vehicle"</span>),</span>
<span id="cb16-781"><a href="#cb16-781" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Queens"</span></span>
<span id="cb16-782"><a href="#cb16-782" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-783"><a href="#cb16-783" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-784"><a href="#cb16-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-787"><a href="#cb16-787" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-788"><a href="#cb16-788" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: Manhattan Vehicle - Noise</span></span>
<span id="cb16-789"><a href="#cb16-789" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-790"><a href="#cb16-790" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb16-791"><a href="#cb16-791" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb16-792"><a href="#cb16-792" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> <span class="fu">c</span>(<span class="st">"Noise - Vehicle"</span>),</span>
<span id="cb16-793"><a href="#cb16-793" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Manhattan"</span></span>
<span id="cb16-794"><a href="#cb16-794" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-795"><a href="#cb16-795" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-796"><a href="#cb16-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-797"><a href="#cb16-797" aria-hidden="true" tabindex="-1"></a>This is a representation of how "Noise - Vehicle" complaints relate against the traffic volume for Queens and Manhattan respectively. These charts are double sided, which means that the Y-axis holds both, traffic volume metrics and the complaint counts without losing out on scale. The boroughs need to be plotted separately, if we do not, then we will lose out on proper scale as well as it looks very messy. </span>
<span id="cb16-798"><a href="#cb16-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-799"><a href="#cb16-799" aria-hidden="true" tabindex="-1"></a>The representation of vehicle noise complaints is a great reality check. While it's easy to assume that they would be tightly correlated, they are not. This is due to people not being bothered by vehicle noise early morning but find it very bothersome towards the night when they want to sleep. </span>
<span id="cb16-800"><a href="#cb16-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-801"><a href="#cb16-801" aria-hidden="true" tabindex="-1"></a>The rest of the boroughs display similar patterns. </span>
<span id="cb16-802"><a href="#cb16-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-803"><a href="#cb16-803" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Illegal - Parking</span></span>
<span id="cb16-804"><a href="#cb16-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-807"><a href="#cb16-807" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-808"><a href="#cb16-808" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: Queens Illegal Parking</span></span>
<span id="cb16-809"><a href="#cb16-809" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-810"><a href="#cb16-810" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb16-811"><a href="#cb16-811" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb16-812"><a href="#cb16-812" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> <span class="fu">c</span>(<span class="st">"Illegal Parking"</span>),</span>
<span id="cb16-813"><a href="#cb16-813" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Queens"</span></span>
<span id="cb16-814"><a href="#cb16-814" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-815"><a href="#cb16-815" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-816"><a href="#cb16-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-819"><a href="#cb16-819" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-820"><a href="#cb16-820" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: Manhattan Illegal Parking</span></span>
<span id="cb16-821"><a href="#cb16-821" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-822"><a href="#cb16-822" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb16-823"><a href="#cb16-823" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb16-824"><a href="#cb16-824" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> <span class="fu">c</span>(<span class="st">"Illegal Parking"</span>),</span>
<span id="cb16-825"><a href="#cb16-825" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Manhattan"</span></span>
<span id="cb16-826"><a href="#cb16-826" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-827"><a href="#cb16-827" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-828"><a href="#cb16-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-829"><a href="#cb16-829" aria-hidden="true" tabindex="-1"></a>Now we start to see some real change. Illegal parking is a huge issue in Manhattan. I worked at Lexington Avenue for a many years. This avenue has a total of five lanes, yet people illegal parked constantly, reducing the lanes available all the way down to one. Two of the side lanes would be blocked by legal parking, the other lane far right was for busses only and one lane was often blocked by people illegally double parking. As we see by the chart, the people of New York will report these issues frequently and they tend to be very time accurate, as reporting illegal parking right away is crucial, not when the person has left. </span>
<span id="cb16-830"><a href="#cb16-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-831"><a href="#cb16-831" aria-hidden="true" tabindex="-1"></a>In Queens, the reports do not follow as closely to the traffic volume, mostly after 12 PM. This may be due to Queens being much bigger then Manhattan and may not get impacted by traffic as much, given that there are much more open spaces, highways and boulevards. After 12pm, queens tends to be a little less active then Manhattan anyway, as most people are in the city working. This would track given the massive rise in complaints towards the night, since a lot of people would be coming back home.</span>
<span id="cb16-832"><a href="#cb16-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-835"><a href="#cb16-835" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-836"><a href="#cb16-836" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: Manhattan Relevant Complaints</span></span>
<span id="cb16-837"><a href="#cb16-837" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-838"><a href="#cb16-838" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb16-839"><a href="#cb16-839" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb16-840"><a href="#cb16-840" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> relevant_complaints,</span>
<span id="cb16-841"><a href="#cb16-841" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Manhattan"</span></span>
<span id="cb16-842"><a href="#cb16-842" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-843"><a href="#cb16-843" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-844"><a href="#cb16-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-845"><a href="#cb16-845" aria-hidden="true" tabindex="-1"></a>Finally we want to look into relevant complaints being analyzed at a hourly level. These are the exact list of complaints shown in the previous section, the map. This data will overwhelm any outliers such as the "Noise -Vehicle" complaints, since everything is being included here. We can see for the map of Manhattan there eis incredibly close correlation between the traffic volume and the relevant complaints. The one big difference is towards the end, after 7 PM, we notice a spike on the number of complaints while traffic volume keeps declining. </span>
<span id="cb16-846"><a href="#cb16-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-847"><a href="#cb16-847" aria-hidden="true" tabindex="-1"></a>Keep in mind this is any relevant complaints here, so think even broken street signs or bad road conditions. I believe that this is the reason why this spike happens in Manhattan, as people will not report most things on the spot. Rather when their day is done, they may recall a pothole or something else that the city is just refusing to handle over time, and decide to send that complaint out when they finally get a minute to do so. I know I have done this for Queens Boulevard, which is riddled with some of the worst potholes I have ever experience while driving in New York. </span>
<span id="cb16-848"><a href="#cb16-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-851"><a href="#cb16-851" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-852"><a href="#cb16-852" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: Queens Relevant Complaints</span></span>
<span id="cb16-853"><a href="#cb16-853" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-854"><a href="#cb16-854" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_complaints_vs_traffic</span>(</span>
<span id="cb16-855"><a href="#cb16-855" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> complaints_traffic_joined,</span>
<span id="cb16-856"><a href="#cb16-856" aria-hidden="true" tabindex="-1"></a>  <span class="at">complaint_types =</span> relevant_complaints,</span>
<span id="cb16-857"><a href="#cb16-857" aria-hidden="true" tabindex="-1"></a>  <span class="at">borough_name =</span> <span class="st">"Queens"</span></span>
<span id="cb16-858"><a href="#cb16-858" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-859"><a href="#cb16-859" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-860"><a href="#cb16-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-861"><a href="#cb16-861" aria-hidden="true" tabindex="-1"></a>Queens has a bit less correlation then Manhattan. Just as we noticed with the illegal parking, on the afternoon the complaints seem to deviate from the direction of the traffic volume. This may be linked to what was pointed before, that Queens gets a bit more inactive on the afternoon. </span>
<span id="cb16-862"><a href="#cb16-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-863"><a href="#cb16-863" aria-hidden="true" tabindex="-1"></a>When I am comparing correlation, I deem Manhattan to be better correlated, because the movement of the complaints volume throughout the day match that of the traffic volume. Queens has the two lines flow closer together but the movement flow does not match as well. </span>
<span id="cb16-864"><a href="#cb16-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-865"><a href="#cb16-865" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb16-866"><a href="#cb16-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-867"><a href="#cb16-867" aria-hidden="true" tabindex="-1"></a>When it comes to analytics, I strongly recommend to not rely on just the numbers. It's very difficult to get a good sense of the impact the data has unless you plot it into a map (if they are coordinates). It helps to see the impact that the data has, because we may just compare and think that it's not as impactful. When it comes to mapping out the data here we got a clear picture on how many 311 complaints get sent out, and these are only the relevant complaints to traffic. </span>
<span id="cb16-868"><a href="#cb16-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-869"><a href="#cb16-869" aria-hidden="true" tabindex="-1"></a>Based on what the hourly analytics resulted, I can confidently say that as traffic volume goes up, related traffic 311 complaints also go up. However we need to be realistic on how people send out complaints. For time sensitive events, such as illegal parking, the data tends to be very reliable with traffic flow. For other events such as car noises, people do not really care to complain until they want to sleep. Also I strongly believe that the major rise in complaints later on the night has to do with people finally having a moment to send it out, as well as wanting some piece and quiet. </span>
<span id="cb16-870"><a href="#cb16-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-871"><a href="#cb16-871" aria-hidden="true" tabindex="-1"></a>My teammates were able to uncover other correlations, such as air pollution complaints being linked to heavy traffic volume. With these findings, NYC can use the 311 complaints to figure out which areas may need more resources. Knowing which intersections receive the most complaints and at what time the traffic is at it's peek, can help the city to send officers so traffic is safer and better organized. </span>
<span id="cb16-872"><a href="#cb16-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-873"><a href="#cb16-873" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Overcoming Challenges </span></span>
<span id="cb16-874"><a href="#cb16-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-875"><a href="#cb16-875" aria-hidden="true" tabindex="-1"></a>We had a bit of an issue with the traffic volume dataset. Some months were missing, so boroughs did not have consistent data. I tried my best to find other datasets, some were locked behind paywalls while promising excellent results (so they say at least). Late into the project I was able to put together some yellow taxicab data, for the trips they make throughout New York. This dataset was not used due to time constraints, as it would require a whole rewriting of our topic at such a late date. </span>
<span id="cb16-876"><a href="#cb16-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-877"><a href="#cb16-877" aria-hidden="true" tabindex="-1"></a>However we made due with what we were able to put together after the 2nd milestone presentation that we made for the project. Thank you!</span>
<span id="cb16-878"><a href="#cb16-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-879"><a href="#cb16-879" aria-hidden="true" tabindex="-1"></a></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>